
\section{Correctness proof}

\subsection{Definitions}
We first define a binary relation $\~\S$ on stores to denote that two stores are $similar$: they have identical domains, and their bound values by $\S$ are the same. 
We call this $\S$ an $overlap$ of these two stores.

\begin{defi}[\textbf{Stores similarity}]
	\label{def-sgm-sim}
	
	$\sgm_1 {\~{\S}} \sgm_2 $
	iff \\
	(1) $dom(\sgm_1) = dom(\sgm_2)$ \\
	(2) $\forall s \in \S.\sgm_1(s)= \sgm_2(s)$ \\
\end{defi}

According to this definition, it is only meaningful to have $\S  \subseteq dom(\sgm_1)$ (= $dom(\sgm_2)$).  
When $\S = dom(\sgm_1) = dom(\sgm_2)$, $\sgm_1$ and $\sgm_2$ are identical. 
It is easy to show that this relation $\overset{\S}{\sim}$ is symmetric and transitive.
\begin{itemize}
	\item If $\sgm_1 \~\S \sgm_2$, then $\sgm_2 \~\S \sgm_1$.
	\item If $\sgm_1 \~\S \sgm_2$ and $\sgm_2 \~\S \sgm_3$, then $\sgm_1 \~\S \sgm_3$.
\end{itemize}


We also define a binary operation $\x\S$ on stores to denote a kind of specical concatenation of two similar stores: 
the $concatenation$ of two similar stores is a new store, in which the bound values by $\S$ are from any of the parameter stores, and 
the others are the concatenation of the values from the two stores. 
In other words, a $concatenation$ of two similar stores is only a concatenation of the bound values that $maybe$ different in these stores.
\begin{defi}[\textbf{Store Concatenation}] \label{def-sgm-join}
	For $\sgm_1 \~\S \sgm_2$,
	$\sgm_1 \x{\S} \sgm_2 = \sgm$ where \\
	$\sgm(s) =
	\begin{cases}
	\sgm_1(s) (=\sgm_2(s)), & s \in \S\\
	\sgm_1(\s) {\++} \sgm_2(s), & s \notin \S \\
	\end{cases} $
\end{defi}

\begin{lem} \label{lem-join1}
	If $\sgm_1 \x{\S} \sgm_2 = \sgm$, 
	then $\sgm_1 \~{\S} \sgm$ and $\sgm_2 \~{\S} \sgm.$
\end{lem}
This lemma says that the concatenation result of two similar stores is still similar to each of them.
%\begin{proof}
%	According to Definition \ref{def-sgm-join}, it is clear that $dom(\sgm) = dom(\sgm_1)$, and $\forall s \in \S. \sgm(s) = \sgm_1(s)$. Then by Definiton \ref{def-sgm-sim}, $\sgm \~\S \sgm_1$
%\end{proof}


\begin{lem} \label{lem-psi-join}
	If \begin{enumerate}[(i)]
	 \item $\sevalfg{\lcall}{\a_{1},...,\a_{k}}{\c_1}{\a_0}$ by some derivation $\MP_1$
	 \item $\sevalfg{\lcall}{\a'_{1},...,\a'_{k}}{\c_2}{\a_0'}$ by some $\MP_2$,
	\end{enumerate}
	then $\sevalfg{\lcall}{\a_{1} {\++} \a'_{1},...,\a_{k} {\++} \a'_{k}}{\c {\++} \c'}{\a {\++} \a'}$ by some $\MP_3$.
\end{lem}

\begin{proof}
\def\cc{\c_1 {\++} \c_2}
\def\aap#1{\a_{#1} {\++} \a_{#1}'}
\def\zk#1{(#1)^k_{i=0}}

	There are two possibilities: 
	\begin{itemize}
		\item Case $\MP_1$ uses $\PName{X-Termi}$.\\
		We must have $\zk{\a_i=\emptyv}$ and $\c_1 = \emptyv$.
		Then $\zk{\aap{i} = \a_i'}$, and $\cc = \c_2 $. Take $\MP_3
		= \MP_2$ and we are done. \\
		
		\item Case $\MP_1$ uses $\PName{X-Loop}$. \\
	   Assume $\c_1 = \<() | \c_1' \'>$, then we have 
		$$
		\PT{
			\UCN{\MP_{11}}{\block{\a_{11}}{\a_{k1}}{\a_{01}}}
			\UCN{\MP_{12}}{\sevalf{\a_{12}}{\a_{k2}}{\c_1'}{\a_{02}}}
 			\LeLa{\MP_1 = }
			\BC{\sevalf{\a_1}{\a_k}{\< c_0 | \c_1' \'>}{\a_0}}
		}$$
	    with $\zk{\a_i = \vapp{\a_{i1}}{\a_{i2}}}$.\\
	    
	    By IH on $\MP_{12}$ with $\MP_2$, we get a derivation $\MP_4$ of 
	    $$\sevalfg{\lcall}{\a_{12} {\++} \a_1',...,\a_{k2} {\++} \a_k'}{\c_1' {\++} \c_2 }{\a_{02} {\++} \a_0'}$$
	    
	    Then using the rule $\PName{X-Loop}$ we can build a derivation $\MP_5$ as follows:
	    	$$
	    \PT{
	    	\UCN{\MP_{11}}{\block{\a_{11}}{\a_{k1}}{\a_{01}}}
	    	\UCN{\MP_{4}}{\sevalfg{\lcall}{\a_{12} {\++} \a_1',...,\a_{k2} {\++} \a_k'}{\c_1' {\++} \c_2 }{\a_{02} {\++} \a_0'}}
	    	\BC{\sevalf{\a_{11} {\++} {(\a_{12} {\++} \a_1')}}
	    		        {\a_{k1} {\++} {(\a_{k2} {\++} \a_k')}}
	    		        {\< () | \c_1' {\++} \c_2 \'>}
	    		        {\a_{01} {\++} {(\a_{02} {\++} \a_0')}}}
	    }$$
	    Since it is clear that 
	    $$\forall i \in \{0,...,k\}. \ \a_{i1} {\++} (\a_{i2} {\++} \a_i') = (\a_{i1} {\++} \a_{i2}) {\++} \a_i' = \a_i {\++} \a_i' $$
	    $$ \< () | \c_1' {\++} \c_2 \'> = \< () | \c_1' \'> {\++} \c_2 = \c_1 {\++} \c_2 $$
	    so take $\MP_3 = \MP_5$ and we are done. 
	    
	\end{itemize}
	
\end{proof}

\begin{lem} \label{lem-emp-join}
	If 
	\begin{enumerate} [(i)]
		\item $\sgm_1 \~{S} \sgm_2$
		\item $\seval{p}{\sgm_1}{\c}{\sgm}$
		\item $\FV{p} \cap \S = \emptyset$
		\item $\forall s \in \FV{p}. \sgm_2(s) = \emptyv$
	\end{enumerate}
	then 
	\begin{enumerate}[(i)]
		\setcounter{enumi}{4}
		\item $\seval{p}{\sgm_1 \x{\S} \sgm_2}{\c}{\sgm'}$
		\item $\forall s' \in \dv{p}. \sgm(s') = \sgm'(s')$
	\end{enumerate}
\end{lem}

\begin{lem} \label{lem-emp-join-sym}
	If 
	\begin{enumerate} [(i)]
		\item $\sgm_1 \~{S} \sgm_2$
		\item $\seval{p}{\sgm_2}{\c}{\sgm}$
		\item $\FV{p} \cap \S = \emptyset$
		\item $\forall s \in \FV{p}. \sgm_1(s) = \emptyv$
	\end{enumerate}
	then 
	\begin{enumerate}[(i)]
		\setcounter{enumi}{4}
		\item $\seval{p}{\sgm_1 \x{\S} \sgm_2}{\c}{\sgm'}$
		\item $\forall s' \in \dv{p}. \sgm(s') = \sgm'(s')$
	\end{enumerate}
\end{lem}

\begin{lem} [\textbf{Stores concatenation lemma}] \label{lem-sgm-join}
	If 
	\begin{enumerate}[(i)]
		\item $\sgm_1 \~{\S} \sgm_2$
		\item $\seval{p}{\sgm_1}{\c_1}{\sgm_1'}$ (by some derivation $\MP_1$)
		\item $	\seval{p}{\sgm_2} {\c_2} {\sgm_2'}$ (by some derivation $\MP_2$)
		\item $\FV{p} \cap \S = \emptyset $
	\end{enumerate}
	then $\seval{p}{\sgm_1 \x\S \sgm_2}{\c_1 {\++} \c_2}{ \sgm_1' \x\S \sgm_2' }$ (by $\MP$).
\end{lem}

We need this lemma to prove that the results of single computations inside a comprehension body (i.e. $p$ in the lemma) can be concatenated to express a parallel computation. From the other direction, we can consider this process as distributing or splitting the compuation $p$ on even smaller degree of parallel computations, in which all the supplier streams, i.e., $\FV{p}$, are splitted to
feed the transducers. The splitted parallel degrees are specified by the
control streams, i.e., $\c_1$ and $\c_2$ in the lemma. Other untouched $\SId$s in all $\sgm$s (i.e., $\S$) have no change throughout the process.\\

\begin{proof}
	By induction on the syntax of $p$.
\def\sgmx{\sgm_1 \x{\S} \sgm_2}
\def\sgmpx{\sgm_1' \x{\S} \sgm_2'}
\def\cc{\c_1 {\++} \c_2}

 
	\begin{itemize}
	\item Case $p = \epsilon$. \\
	$\MP_1$ must be $\overline{\seval{\epsilon}{\sgm_1}{\c_1}{\sgm_1}}$, and
	$\MP_2$ must be $\overline{\seval{\epsilon}{\sgm_2}{\c_2}{\sgm_2}}$. \\
	So $\sgm_1' = \sgm_1$, and $\sgm_2' = \sgm_2$, thus $\sgm_1' \x{\S} \sgm_2' = \sgm_1 \x{\S} \sgm_2$. \\
	
	By $\PName{Empty}$, we take $\MP$ = $\overline{\seval{\epsilon}{\sgmx}{\c_1 {\++} \c_2}{\sgmx}}$ and we are done. 
	
\item Case $p = \sdef{\s_l}{\lcall(s_1,...,s_k)}.$ \\
\def\casetwo{\sdef{\s_l}{\lcall\Tupk\s}}	
\def\eqnumtwo#1{eq-lem24-c2-{#1}}
	$\MP_1$ must look like 
	$$\PT{\UCN{\MP'_{1}}{\sevalf{\a_1}{\a_k}{\c_1}{\a}}
			\UC{\seval{\sdef{\s_l}{\lcall\Tupk\s}}{\sgm_1}{\c_1}{\sgm_1[\s_l \|-> \a]}}
	} $$

	and we have 
	    \eq{eq-lem24-c2-1}{(\sgm_1(\s_i) = \a_i)^k_{i=1}}
	
	
    Similarly, $\MP_2$ must look like 
	$$\PT{\UCN{\MP'_{2}}{\sevalf{\a_1'}{\a_k'}{\c_2}{\a'}}
		\UC{\seval{\sdef{\s_l}{\lcall\Tupk\s}}{\sgm_2}{\c_2}{\sgm_2[\s_l \|-> \a']}}
	} $$
	
	and we have
	\eq{eq-lem24-c2-2}{(\sgm_2(\s_i) = \a_i')^k_{i=1}}
	
	So  $\sgm_1' = \sgm_1[\s_l \|-> \a], \sgm_2' = \sgm_2[\s_l \|-> \a']$. \\
	
	From assumption $(iv)$ we have $\FV{\casetwo} \cap \S = \emptyset$,
    that is, 
	\eq{eq-lem24-c2-3}{\{s_1,...,s_k\} \cap \S = \emptyset}

    
    By Lemma \ref{lem-psi-join} on $\MP'_{1}$, $\MP'_{2}$, we get a derivation $\MP'$ of 
    \[ \sevalfg{\lcall}{\a_1  {\++} \a_1',...,\a_k {\++} \a_k' } 
             {\c_1 {\++} \c_2} {\a {\++} \a'} \]
    
    Since $\sgm_1 \~{\S} \sgm_2$, 
    with \eqref{eq-lem24-c2-1},\eqref{eq-lem24-c2-2} and \eqref{eq-lem24-c2-3}, 
    by Definition $\ref{def-sgm-join}$ we have
    \eq{\eqnumtwo{5}}{
	    \forall i \in \{1,...,k\}.\sgmx(\s_i) = \sgm_1(\s_i) {\++} \sgm_2(\s_i) = \a_i {\++} \a_i'}
 	Also, it is easy to prove that $\sgm_1[\s_l \|-> \a] \x{\S} \sgm_2[\s_l \|-> \a'] \~\S \sgmx[\s_l \|-> \a {\++} \a'] $ and \eq{\eqnumtwo{4}}{
 		\sgm_1[\s_l \|-> \a] \x{\S} \sgm_2[\s_l \|-> \a'] = 
 		\sgmx[\s_l \|-> \a {\++} \a']
 	}
 
    Using the rule $\PName{Xducer}$ with $\eqref{\eqnumtwo{5}}$, we can build $\MP''$ as follows
   	$$\PT{\UCN{\MP'}{\sevalfg{\lcall}{\a_1  {\++} \a_1',...,\a_k {\++} \a_k' } 
   			{\c_1 {\++} \c_2} {\a {\++} \a'}}
    	\UC{\seval{\casetwo}{\sgmx}{\c_1 {\++} \c_2}{\sgmx[\s_l \|-> \a {\++} \a']}}
    } $$
   
   
    Replacing $\sgmx[\s_l \|-> \a {\++} \a']$ in $\MP''$ with the left-hand side of $\eqref{\eqnumtwo{4}}$ gives us $\MP$ 
   	$$\PT{\UCN{\MP'}{\sevalfg{\lcall}{\a_1  {\++} \a_1',...,\a_k {\++} \a_k' } 
   			{\c_1 {\++} \c_2} {\a {\++} \a'}}
   		\UC{\seval{\casetwo}{\sgmx}{\c_1 {\++} \c_2}{\sgm_1[\s_l \|-> \a] \x{\S} \sgm_2[\s_l \|-> \a']}}
   	} $$ as required.
   	

\item Case $p = \withctrl{\s_c}{p_0}{\Sin}{\Sout}$ where  
\def\eqnumthree#1{eq-lem24-c3-{#1}}

 \eq{eq-lem24-c3-1}{\FV{p_0} \subseteq \Sin}
 \eq {eq-lem24-c3-2}{\Sout \subseteq \dv{p_0}}

\def\casethree{\withctrl{\s_c}{p_0}{\Sin}{\Sout}}

	From the assumption ($iv$), we have 
	\begin{align*}
	\FV{\casethree} \cap \S & = \emptyset \\
	(\{\s_c\} \cup \Sin) \cap \S & = \emptyset \tag{by definition of $\FV{}$} 
	\end{align*}
	thus 
	\eq{eq-lem24-c3-3}{\{\s_c\} \cap \S = \emptyset}
	\eq{eq-lem24-c3-4}{\Sin \cap \S = \emptyset}
	
    Since \eqref{eq-lem24-c3-1} with \eqref{eq-lem24-c3-4}, we also have 
    	\eq{eq-lem24-c3-6}{\FV{p_0} \cap \S = \emptyset}
    
    Assume $\Sout = [s_1,...,s_j]$. \\	
    There are four possibilities: 
   
    \begin{itemize}


    	\item Subcase both $\MP_1$ and $\MP_2$ use $\PName{Wc-Emp}$. \\
    	
    	So $\MP_1$ must look like 
    	
    	$$\PT{
    		\Axiom{\seval{\casethree}{\sgm_1}{\c_1}{\sgm_1[\s_1 \|-> \emptyv, ..., \s_j \|-> \emptyv]}}
    	}$$
    	and we have   \eq{eq-lem24-c3-5}{  	
    		\forall s \in \{\s_c\} \cup \Sin. \sgm_1(s) = \emptyv}
        thus
    		\eq{eq-lem24-c3-7}{\sgm_1(s_c) = \emptyv}
    	  	\eq{\eqnumthree{8}}{\forall s \in \FV{p_0}. \sgm_1(s) = \emptyv}
    	
    	Similarly,$\MP_2$ must look like  	
    	$$\PT{
    		\Axiom{\seval{\casethree}{\sgm_2}{\c_2}{\sgm_2[\s_1 \|-> \emptyv, ..., \s_j \|-> \emptyv]}}
    	}$$
    	and we have   \eq{eq-lem24-c3-9}{  	
    		\forall s \in \{\s_c\} \cup \Sin. \sgm_2(s) = \emptyv}
    	thus
    	\eq{eq-lem24-c3-10}{\sgm_2(s_c) = \emptyv}
    	\eq{\eqnumthree{11}}{\forall s \in \FV{p_0}. \sgm_2(s) = \emptyv}

 \def\sgmbe#1{\sgm_#1[\j{\s_i \|-> \emptyv}]}
    	
    	So $\sgm_1' = \sgmbe{1}$, $\sgm_2' = \sgmbe{2}$. \\
    	
 	Since $\sgm_1 \~{\S} \sgm_2$, by Definition $\ref{def-sgm-join}$ with \eqref{eq-lem24-c3-3}, \eqref{eq-lem24-c3-4}, and  \eqref{eq-lem24-c3-5}, \eqref{eq-lem24-c3-9}, we have    		
   		\eq{\eqnumthree{8}}{\forall s \in \{\s_c\} \cup \Sin. \sgmx(\s) = \sgm_1(\s) {\++} \sgm_2(s) =  \emptyv}
   		
   		Also, it is easy to show that $\sgmbe1 \~{\S} \sgmbe2$ and 
   		\eq{\eqnumthree{7}}{
   			\sgmbe1 \x{\S} \sgmbe2 = \sgmx[\j{\s_i \|-> \emptyv}]
   		}
   	
    Using $\PName{Wc-Emp}$ with $\eqref{\eqnumthree{8}}$, we build $\MP'$ as follows
   		$$\PT{
   			\Axiom{\seval{\casethree}{\sgmx}{\cc}{(\sgmx)[\j{\s_i \|-> \emptyv}]}}
   		}$$
   	
   	Then replcaing $\sgmx[\j{\s_i \|-> \emptyv}]$ in $\MP'$ with the left-hand side of $\eqref{\eqnumthree{7}}$ gives us $\MP$ of \\
   \makebox[0.9\textwidth][c]{		$$\PT{
   			\Axiom{\seval{\casethree}{\sgmx}{\cc}{\sgmbe1 \x{\S} \sgmbe2}}
   		}$$}
   		as required. \\
   
   	\item Subcase $\MP_1$ uses  $\PName{Wc-Nomemp}$, $\MP_2$ uses $\PName{Wc-Emp}$. \\
  \def\sgmbpp#1{\sgm_{#1}[\j{\s_i \|-> \sgm_{#1}''(\s_i)}]}   	
   	$\MP_1$ must look like
   	$$\PT{
   			\UCN{\MP_1'}{\seval{p_0}{\sgm_1}{\c_1'}{\sgm_1''}}
   			\UC{\seval{\casethree}{\sgm_1}{\c_1}{\sgmbpp1}}
   	}$$
    and we have 
    \eq{\eqnumthree{20}}{\sgm_1(\s_c)= \c_1' = \< () | ...\'>}
   	
   	$\MP_2$ must look like	
   	$$\PT{
   		\Axiom{\seval{\casethree}{\sgm_2}{\c_2}{\sgmbe{2}}}
   	}$$
   	and we have  
   	$\forall s \in \{\s_c\} \cup \Sin. \sgm_2(s) = \emptyv$
   thus
	\eq{\eqnumthree{21}}{\sgm_2(s_c) = \emptyv}
	\eq{\eqnumthree{22}}{\forall s \in \FV{p_0}. \sgm_2(s) = \emptyv}   	
 


	
	So $\sgm_1' = \sgmbpp{1}$, $\sgm_2' = \sgmbe{2}$.

    By Lemma \ref{lem-emp-join} on $\sgm_1 \~{\S} \sgm_2$ with $\MP_1'$, \eqref{\eqnumthree{22}}, \eqref{eq-lem24-c3-6}, we obtain a derivation $\MP_0$
    of 
    $$\seval{p_0}{\sgmx}{\c_1'}{\sgm_0}$$ for some $\sgm_0$, and 
    $$\forall s \in dv(p_0). \sgm_0(s) = \sgm_1''(s), $$
    thus,  with \eqref{eq-lem24-c3-2}, we have
    \eq{\eqnumthree{25}} {(\sgm_0(s_i) = \sgm_1''(s_i))^j_{i=1}}
    

%   		
   	Since $\sgm_1 \~\S \sgm_2$,	by Definition \ref{def-sgm-join} with $\eqref{\eqnumthree{20}}$, $\eqref{\eqnumthree{21}}$, we have \eq{\eqnumthree{27}}{
   		\sgmx(s_c) = \sgm_1(s_c) {\++} \sgm_2(s_c) = \c_1' =  \<()| ...\'>}
   	
   	and it is also easy to prove $\sgmbpp{1} \~\S \sgmbe{2}$ and \eq{\eqnumthree{26}}{
   		\sgmbpp{1} \x{\S} \sgmbe{2} =  
   		 \sgmx[\j{\s_i \|-> \sgm_{1}''(\s_1)}]
   	}	
   
     Using the rule $\PName{Wc-Nonemp}$ with $\eqref{\eqnumthree{27}}$ we can build a derivation $\MP'$ as follows 	
  		$$\PT{
  			\UCN{\MP_0}{\seval{p_0}{\sgmx}{\c_1'}{\sgm_0}}
  			\UC{\seval{\casethree}{\sgmx}{\cc}{(\sgmx) [\j{\s_i \|-> \sgm_0(\s_i)}]}}
  		}$$ 
  	
  	With $\eqref{\eqnumthree{25}}$, we replace $\sgm_0(s_i)$ with $\sgm_1''(s_i)$ for $ \forall i \in \{1,...,j\}$ in $\MP'$, obtaining  
  		$$\PT{
  		\UCN{\MP_0}{\seval{p_0}{\sgmx}{\c_1'}{\sgm_0}}
  		\UC{\seval{\casethree}{\sgmx}{\cc}{(\sgmx) [\j{\s_i \|-> \sgm_1''(\s_i)}]}}
  	}$$ 
  		
  	Then replacing $(\sgmx) [\j{\s_i \|-> \sgm_1''(\s_i)}]$ in $\MP'$ with the left-hand side of $\eqref{\eqnumthree{26}}$, we get $\MP$ of \\
  	 \makebox[0.9\textwidth][c]{\PT{
  	 	\UCN{\MP_0}{\seval{p_0}{\sgmx}{\c_1'}{\sgm_0}}
  	 	\UC{\seval{\casethree}{\sgmx}{\cc}{\sgmbpp{1} \x{\S} \sgmbe{2}}}
  	 }}
    as required. \\
  
	\item Subcase $\MP_1$ uses  $\PName{Wc-Emp}$ and $\MP_2$ uses $\PName{Wc-Nonemp}$. \\	
	This subcase is symmetric to the second one, so the proof is analogous except that this subcase uses Lemma $\ref{lem-emp-join-sym}$ rather than  Lemma $\ref{lem-emp-join}$.\\
 		
	\item Subcase both $\MP_1$ and $\MP_2$ use $\PName{Wc-Nonemp}$. \\
 	$\MP_1$ must look like
 	$$\PT{
 		\UCN{\MP_1'}{\seval{p_0}{\sgm_1}{\c_1'}{\sgm_1''}}
 		\UC{\seval{\casethree}{\sgm_1}{\c_1}{\sgmbpp1}}
 	}$$
 	and 
 	\eq{\eqnumthree{30}}{\sgm_1(\s_c)= \c_1' = \< () | ...\'>}
 	
 	Similarly, $\MP_2$ must look like
 	$$\PT{
 		\UCN{\MP_2'}{\seval{p_0}{\sgm_2}{\c_2'}{\sgm_2''}}
 		\UC{\seval{\casethree}{\sgm_2}{\c_2}{\sgmbpp2}}
 	}$$
 	and 
 	\eq{\eqnumthree{31}}{\sgm_2(\s_c)= \c_2' = \< () | ...\'>}
    
    So $\sgm_1' = \sgmbpp{1}, \sgm_2' = \sgmbpp{2}.$
    
    By IH on $\MP_1'$, $\MP_2'$ with \eqref{eq-lem24-c3-6}, we get a derivation $\MP_0$ of 
    $$\seval{p_0}{\sgmx}{\c_1' {\++} \c_2'}{\sgm_1'' \x{\S} \sgm_2''}$$
    
    Since $ \forall i \in \{1,...,j\}. s_i \notin \S$ ,
    then by Definition $\ref{def-sgm-join}$, we know
    \eq{\eqnumthree{32}}{\sgm_1'' \x{\S} \sgm_2''(\s_i) = \sgm_1''(\s_i) {\++} \sgm_2''(\s_i)}
    
    Also, it is easy to show that $\sgmbpp{1} \~{\S} \sgmbpp{2}$,
    and
   \eq{\eqnumthree{34}}
   	{\begin{split}
    	 \sgmbpp{1} \x{\S} \sgmbpp{2}  \\ 
    	 = \sgmx[\j{\s_i \|-> \sgm_1''(\s_i) {\++} \sgm_2''(\s_i)}] 
    \end{split}}  
    thus, with  \eqref{\eqnumthree{32}},  
    \eq{\eqnumthree{35}}{
    	\begin{split}
    	 \sgmbpp{1} \x{\S} \sgmbpp{2} \\
    		= \sgmx[\j{\s_i \|-> \sgm_1'' \x{\S} \sgm_2''(\s_i)}] 
    	\end{split}
   }  	

   	Since $\eqref{eq-lem24-c3-3}$ with $\eqref{\eqnumthree{30}}$,  $\eqref{\eqnumthree{31}}$, we know $\sgmx(\s_c)$ = $\c_1' {\++}  \c_2' = \<()|...\'>$,
   	therefore we can use the rule $\PName{Wc-Nonemp}$ to build a derivation $\MP'$ as follows:
   	$$\PT{
   		\UCN{\MP_0}{\seval{p_0}{\sgmx}{\c_1' {\++} \c_2'}{\sgm_1'' \x{\S} \sgm_2''}}
   		\UC{\seval{\casethree}{\sgmx}{\cc}{\sgmx[\j{\s_i \|-> \sgm_1'' \x{\S} \sgm_2''(\s_i)}]}}
   	}$$.
   
    Then replacing $\sgmx[\j{\s_i \|-> \sgm_1''\x{\S} \sgm_2''(s_j)}]$ with the left-hand side of $\eqref{\eqnumthree{35}}$, we obtain $\MP$ of
   	 	$$\PT{
   		\UCN{\MP_0}{\seval{p_0}{\sgmx}{\c_1' {\++} \c_2'}{\sgm_1'' \x{\S} \sgm_2''}}
   		\UC{\seval{\casethree}{\sgmx}{\cc}{\sgmbpp{1} \x{\S} \sgmbpp{2}}}
   	}$$ as required.
   
    \end{itemize}

	\item Case $p = p_1;p_2$ \\
\def\eqnumfour#1{eq-lem24-c4-{#1}}

	 We must have 
	$$	\PT{
				\UCN{\MP_1'}{\seval{p_1}{\sgm_1}{\c_1}{\sgm_1''}}
				\UCN{\MP_1''}{\seval{p_2}{\sgm_1''}{\c_1}{\sgm_1'}}	
				\LeLa{\MP_1 = }
				\BC{\seval{p_1;p_2}{\sgm_1}{\c_1}{\sgm_1'}}
		}$$	
	and
	 $$ \PT{
	  		\UCN{\MP_2'}{\seval{p_1}{\sgm_2}{\c_2}{\sgm_2''}}
	  		\UCN{\MP_2''}{\seval{p_2}{\sgm_2''}{\c_2}{\sgm_2'}}	
	  		\LeLa{\MP_2 = }
	  		\BC{\seval{p_1;p_2}{\sgm_2}{\c_1}{\sgm_2'}}
	  }	$$
	
	Since $\FV{p_1;p_2} \cap \S = \emptyset$, we have $(\FV{p_1} \cup \FV{p_2} - \dv{p_1}) \cap \S = \emptyset$, thus 
	\eq{\eqnumfour{1}}{\FV{p_1} \cap \S = \emptyset}
    \eq{\eqnumfour{2}}{\FV{p_2} \cap \S = \emptyset}

\def\sgmxpp{\sgm_1'' \x{\S} \sgm_2''}    

    By IH on $\MP_1'$, $\MP_2'$, \eqref{\eqnumfour{1}}, we get $\MP'$ of
    $$\seval{p_1}{\sgmx}{\cc}{\sgmxpp}$$
    
    By Definition \ref{def-sgm-join}, we must have $\sgm_1'' \~\S \sgm_2''$.
    
    Then by IH on $\MP_1''$, $\MP_2''$ with \eqref{\eqnumfour{2}}, we get $\MP''$ of $$\seval{p_2}{\sgmxpp}{\cc}{\sgmpx}$$
    
    Therefore, we use the rule $\PName{Seq}$ to build $\MP$ as follows:
    	 $$ \PT{
    		\UCN{\MP'}{\seval{p_1}{\sgmx}{\cc}{\sgmxpp}}
    		\UCN{\MP''}{\seval{p_2}{\sgmxpp}{\cc}{\sgmpx}}	
    		\BC{\seval{p_1;p_2}{\sgmx}{\cc}{\sgmpx}}
    	}	$$
     and we are done.
	\end{itemize}
\end{proof}

Let $\sgm_1 \ConEq{\s} \sgm_2$ denote $\forall \s' < \s. \sgm_1(\s') = \sgm_2(\s')$. 
	
\begin{lem}\label{lem-join2}
	If $\sgm_1 \~{\S_1} \sgm'_1$, $\sgm_2 \~{\S_2} \sgm'_2$, $\sgm_1 \ConEq{s} \sgm_2$,
	and $\sgm'_1 \ConEq{\s} \sgm_2'$  
	then $\sgm_1 \x{\S_1} \sgm_1' \ConEq{s} \sgm_2 \x{\S_2} \sgm'_2$. 
\end{lem}




\subsection{Correctness proof}

\begin{lem}
	\label{function-correctness}
	If 
	\begin{enumerate}[(i)]
	\item $\Typef{\hcall}{\replc{k}{\tau}}\tau$ (by some derivation $\MT$)
	\item $\EvalF{\hcall}{\replc{k}{v}}{v}$ (by $\ME$)
	\item $\Transf{\hcall}{\replc k {\st}} {\s_0} {\s_1} {\sfun{p}{\st}}$ (by $\MC$)
 	\item $(\ValRep{v_i}{\tau_i}{\sgm(\st_i)})^k_{i=1}$
 	\item $\bigcup^k_{i=1}\sids{\st_i} \.< \s_0$
	\end{enumerate}
 	then 
 	\begin{enumerate}[(i)]
 		\setcounter{enumi}{5}
 		\item $\seval{p}{\sgm}{\vunit}{\sgm'}$ (by $\MP$)
 		\item $\ValRep{v}{\tau}{\sgm'(\st)}$ (by $\MR$)
 		\item $\sgm' \ConEq{s_0} \sgm $
 	    \item $\s_0 \le \s_1$
 		\item $\sids{\st} \.< \s_1$

 	\end{enumerate}
\end{lem}

\begin{proof}
By inducntion on the syntax of $\hcall$.
\begin{itemize}
	\item \label{thm-case-const} Case $\hcall = \constn{n}$ \\ 	
	There is only one possibility for each of $\MT$, $\ME$ and $\MC$:
	$$\MT = \PT{ \Axiom{\Typef{\constn{n}}{}{\int}}}$$
	$$\ME = \PT{\Axiom{\Eval{}{\const{n}}{n}}}$$
	$$\MC = \PT{\Axiom{\Transf{\constn{n}}{}{\s_0}{\s_0+1}
			{\sfun{\sdef{\s_0}{\constaf{n}}}{\s_0}}}}$$

\def\pconst{\sdef{\s_0}{\constaf{n}}}
	So $k=0,\tau = \int, v = n, p = \pconst$, $\s_1 = \s_0+1$, and $\st = \s_0$

	By $\PName{Xducer}$, $\PName{X-Loop}$, $\PName{X-Termi}$ and $\PName{Const}$, we can construct $\MP$ as follows:
	$$\PT{
		\Axiom{\blockf{\consta{n}}{}{\singl{n}}}
		\Axiom{\sevalfg{\consta{n}}{}{\emptyv}{\emptyv}}
		\BC{\sevalfg{\consta{n}}{}{\vunit}{\singl{n}}}
		\LeLa{\MP = }
		\UC{\seval{\pconst}{\sgm}{\vunit}{\sgm[\s_0 \|-> \singl{n}]}}			
	}$$
	So $\sgm' = \sgm[\s_0 \|-> \singl{n}]$.
	
	Then we take $\MR$ = $\PT{\Axiom{\ValRep{n}{\int}{\sgm'(\s_0)}}}$. \\
	Also clearly, $\sgm' \ConEq{\s_0} \sgm$, $\s_0 \le \s_0 +1$, 
	$\sids{\s_0} \.< \s_0 +1$, and we are done.
		
	\item \label{thm-case-plus} Case $\hcall = \plusn$ \\ 	
	We must have 
	$$\MT = \PT{\Axiom{\Typef{\plusn}{\int,\int}{\int}}}$$
	$$\ME = \PT{\Axiom{\Eval{}{\plus{n_1}{n_2}}{n_3}}}$$ where $n_3 = n_2 + n_1$, and 
	$$\MC = \PT{\Axiom{\Transf{\plusn}{s_1,s_2}{\s_0}{s_0+1}
			{\sfun{\sdef{\s_0}{\maptwof{+}{\s_1}{\s_2}}}}{\s_0}}}$$

\def\pplus{\sdef{\s_0}{\maptwof{+}{\s_1}{\s_2}}}	
	So $k=2,\tau_1 = \tau_2 = \tau = \int, v_1= n_1, v_2= n_2, v = n_3,
	 \st_1= \s_1, \st_2 = \s_2, \st = \s_0, \s_1 = \s_0 +1$
	 and $p = \pplus$. \\
	 
	 Assumption (iv) gives us
	 $\infer{\ValRep{n_1}{\int}{\sgm(\s_1)}}{}$ and 
	 $\infer{\ValRep{n_2}{\int}{\sgm(\s_2)}}{}$, which implies
	 $\sgm(\s_1) = \singl{n_1}$ and $\sgm(\s_2) = \singl{n_2}$ respectively. \\
	 
	 For (v) we have $\s_1 < \s_0$ and $\s_2 < \s_0$. \\
	 
	 Then using $\PName{Xducer}$ with $\sgm(\s_1)= \singl{n_1}$ and $ \sgm(\s_2) = \singl{n_2}$, 
	 and using $\PName{X-Loop}$ and $\PName{X-Termi}$, 
	 we can build $\MP$ as follows: 
	 $$\PT{
		\Axiom{\blockf{\maptwo{+}}{\singl{n_1}, \singl{n_2}}{\singl{n_3}}}
		\Axiom{\sevalfg{\maptwo{+}}{\emptyv,\emptyv}{\emptyv}{\emptyv}}
		\BC{\sevalfg{\maptwo{+}}{\singl{n_1},\singl{n_2}}{\vunit}{\singl{n_3}}}
		\UC{\seval{\pplus}{\sgm}{\vunit}{\sgm[\s_0 \|-> \singl{n_3}]}}
	 }$$  
	
	
	Therefore, $\sgm' = \sgm[\s_0 \|-> \singl{n_3}]$.\\
	Now we can take $\MR = \infer{\ValRep{n_3}{\int}{\sgm'(\s_0)}}{}$,
	and it is clear that
	 $\sgm' \ConEq{\s_0} \sgm$, $\s_0 \le \s_0 +1$ 
	 and $\sids{\s_0} \.< \s_0+1$ as required. 
	
%case iota	
	\item \label{thm-case-iota} Case $\hcall = \iotan$ \\ 	
	
\end{itemize}
\end{proof}


\begin{thm}
	\label{mainthm-correctness}
	\textbf{If} 
	\begin{enumerate}[(i)]
		\item $\Type{\Gam}{e}{\tau}$ (by some derivation $\MT$)
		\item $\Eval{\rho}{e}{v}$ (by some $\ME$) 
		\item $\Trans{\del}{e}{\s_0}{\s_1}{\sfun{p}{\st}}$ (by some $\MC$)
		\item \label{mainthm-assum-env} $\forall x \in dom(\Gam). \Type{}{\rho(x)}{\Gam(x)$ } 
		\item $\forall x \in dom(\Gam). \ol{\del(x)} \.< \s_0  $
		\item $\forall x \in dom(\Gam). \ValRep{\rho(x)}{\Gam(x)}{\sgm(\del(x))}$
	\end{enumerate}
	then
	\begin{enumerate}[(i)]
		\setcounter{enumi} {6}
		\item $\seval{p}{\sgm}{\singl{()}}{\sgm'}$ (by some derivation $\MP$)
		\item  $\ValRep{v}{\tau}{\sgm'(\st)}$ (by some $\MR$)
		\item $\sgm' \ConEq{s_0} \sgm $
	    \item $\s_0 \le \s_1$
		\item  $\ol{\st} \.< \s_1$
	\end{enumerate} 
\end{thm}

\begin{proof}
	By induction on the syntax of $e$.
	
	\begin{itemize}
		\item Case $e = \Comp{e_1}{x}{y}{\usevars}$. \\
\def\eqnum#1{eq-mainproof-#1}  

\def\kunit{\vrange{()_1}{()_k}} 
\def\stwo{\< \F_1,..., \F_k, \T \'>}
\def\sgmszs{\sgm[\s_0 \|-> \kunit, \st_2 \>-> \sgm''(\st_2)]}
\def\sgmsz{\sgm[\s_0 \|-> \kunit]}

		We must have: 
		\begin{enumerate}[(i)]
		\item 
		$$\PT{
			\UCN{\MT_1}{\Type{ [x \|-> {\tau_1}, x_1 \|-> \int,...,x_j \|-> \int ]}{e_1}{\tau_2}}
			\LeLa{\MT = }
			\UC{\Type{\Gam}{\Comp{e_1}{x}{y}{\usevars}}{\tseq{\tau_2}}}
		} $$
	    with $$\Gam(y)=\tseq{\tau_1}$$
	        $$\j{\Gam(x_i) = \int}$$
		
		\item
		\[\PT{
			\AC{\left(
				\begin{aligned}
					&\ME_i \\
					\Eval{[x \|-> {v_i}, x_1 \|-> n_1,...& , x_j \|-> n_j]}{e_1}{v_i'}
				\end{aligned}\right)^k_{i=1}}
			\LeLa{\ME = }
			\UC{\Eval{\rho}{\Comp{e_1}{x}{y}{\usevars}}{\Seqk{v'}}}
		}\]
	    with $$\rho(y)=\Seqk{v} $$
	    \[\j{\rho(x_i) = n_i}\]
		
		\item 
		\[\PT{
			\UCN{\MC_1}{\Trans{[x \|-> {\st_1}, x_1 \|-> s_1,...,x_j \|-> s_j]}{e_1}{\s_0+1+j}{\s_1}{\sfun{p_1}{\st_2}}}
			\LeLa{\MC = }
			\UC{\Trans{\del}{\Comp{e_1}{x}{y}{\usevars}}{\s_0}{\s_1}
				{\sfun{p}{(\st_2,\s_b)}}}
		}\]
	    with
	    	\begin{align*}
	    		\del(y) = &  \ (\st_1,\s_b) \\
	    		\j{\del(x_i) = & \ \s_i'} \\
	    		p = & \ \sdef{\s_0}{\usum(\s_b)}; \\
	    		& \ \j{\sdef{\s_i}{\distrf{\s_b}{\s_i'}};} \\
	    		& \ \withctrl{\s_0}{p_1}{\Sin}{\Sout} \\
	    		\Sin = &  \ \FV{p_1} \\
	    		\Sout = & \ \overline{\st_2} \cap \dv{p_1} 
	    	\end{align*}
		    \eq{\eqnum{1}}{\s_{i+1} =  \ \s_i + 1, \forall i \in \{0,...,j-1\}}  \\

	
	 So $\tau = \tseq{\tau_2}, v = \Seqk{v'}, \st = (\st_2,\s_b). $ \\

	\item $\Type{}{\rho(y)}{\Gam(y)}$ gives us $\Type{}{\Seqk{v}}{\tseq{\tau_1}}$, 
	which must have the derivation:
	\eq{\eqnum{20}}{
		\PT{
			\AC{(\Type{}{v_i}{\tau_1})^k_{i=1}}
			\UC{\Type{}{\Seqk{v}}{\tseq{\tau_1}}}}
	}
	and clearly for $\forall i \in \{1,...,j\}, \Type{}{\rho(x_i)}{\Gam(x_i)}$, that is 
	   \eq{\eqnum{2}}{\j{\ol{\Type{}{n_i}{\int}}}}.  
	
	\item 
	$\ol{\del(y)} \.< \s_0$ gives us
	\begin{equation} \label{\eqnum{21}}
	    \ol{\del(y)} = \ol{(\st_1,\s_b)} 
	    = \ol{\st_1} {\++} [\s_b] \.< \s_0
 	\end{equation}
 	and $\j{\ol{\del(x_i)}} \.< \s_0$ implies $[\s_1',...,\s_j'] \.< \s_0$.
	
	
	\item 
	Since $\ValRep{\rho(y)}{\Gam(y)}{\sgm(\del(y))} =
 	 \ValRep{\Seqk{v}}{\tseq{\tau_1}}{\sgm((\st_1,\s_b))}$, 
 	 which must have the derivation: 
 	 \eq{comp-ass-valrep}{
 	 \PT{
		\AC{\left(
			\begin{aligned}
				& \quad \MR_i \\
				& \ValRep{v_i}{\tau_1}{\v_i}
			\end{aligned}
			\right)^k_{i=1}}
		\UC{\ValRep{\Seqk{v}}{\tseq{\tau_1}}{(w,\stwo)}}
	 }}
    where $w =  w_1 \ {\++} ... {\++} \ w_k$,
    therefore we have
    \eq{comp-ass-sgmst1} {\sgm(\st_1) = w}
    \eq{comp-ass-sgms2}	{\sgm(\s_b) = \< \F_1,..., \F_k, \T \'>.}
    
    Also,  for $\forall i \in \{1,...,j\}$, $\ValRep{\rho(x_i)}{\Gam(x_i)}{\sgm(\del(x_i))} = \ValRep{n_i}{\int}{\sgm(\s_i')}$, which implies 
    \eq{\eqnum{3}}{\j{\sgm(\s_i') = \singl{n_i}}}  
	\end{enumerate}


%%%% local shothands
\def\compp{\begin{aligned} 
		&\sdef{\s_0}{\usum(\s_b)}; \\
		&\j{\sdef{\s_i}{\distrf{\s_b}{\s_i'}};} \\
		&\withctrl{\s_0}{p_1}{\Sin}{\Sout} 
	\end{aligned}}

\def\comppp{\begin{aligned} 
		&\j{\sdef{\s_i}{\distrf{\s_b}{\s_i'}};} \\
		&\withctrl{\s_0}{p_1}{\Sin}{\Sout} 
\end{aligned}}

\def\compppp{\begin{aligned} 
		&(\sdef{\s_i}{\distrf{\s_b}{\s_i'}})^j_{i=2}; \\
		&\withctrl{\s_0}{p_1}{\Sin}{\Sout} 
\end{aligned}}

\def\usumdef{\sdef{\s_0}{\usum(\s_b)}} 
\def\distrdef{\sdef{\s_i}{\distrf{\s_b}{\s_i'}}} 
\def\wcdef{\withctrl{\s_0}{p_1}{\Sin}{\Sout}}
\def\kn#1{\<\overbrace{n_#1,...,n_#1}^{k}\'>} 
 
 
%%%% proof		
First we shall show: 
	\begin{enumerate}[(i)]
	\setcounter{enumi}{6}
	\item \label{comp-5} $\seval{\compp}{\sgm}{\singl{()}}{\sgm'}$
	by some $\MP$
	\item $\ValRep{\Seqk{v'}}{\tseq{\tau_2}}{\sgm'((\st_2,\s_b))}$ by some $\MR$ \\

Using $\PName{Seq}$ $(j+1)$ times, we can build $\MP$ as follows:

{\normalsize
\makebox[0.9\textwidth][c]{ \PT{
	\UCN{\MP_0}{\seval{\sdef{\s_0}{\usumf{\s_b}}}{\sgm}{\singl{()}}{\sgm_0}}
	\UCN{\MP_1}{\seval{\sdef{\s_1}{\distrf{\s_b}{\s_1'}}}{\sgm_0}{\singl{()}}{\sgm_1}}
	\UCN{\MP_{j+1}}{\infer*{}{
	      \infer{}
	      	{\MP_j &  \seval{\withctrl{\s_0}{p_1}{\Sin}{\Sout}}{\sgm_j}{\singl{()}}{\sgm'}}}}
	\UC{\seval{\compppp}{\sgm_1}{\singl{()}}{\sgm'}}
	\BC{\seval{\comppp}{\sgm_0}{\singl{()}}{\sgm'}}
	\BC{\seval{\compp}{\sgm}{\singl{()}}{\sgm'}}}
}}\\

 in which for $\forall i \in \{1,...,j\}$, $\MP_i$ is a derivation of  $\seval{\distrdef}{\sgm_{i-1}}{\vunit}{\sgm_{i}}$.
 

 
  For $\MP_0$, with $\sgm(\s_b) = \stwo$, we can build it as follows:
  
    $$\PT{
    	\AC{ \infer*{\blockf{\usum}{\<\F_2,...,\F_k,\T\'>}{\< ()_2,...,()_k\'>}} 
    				{by \ \PName{UsumT} \  \vcenter{\infer {\blockf{\usum}{\singl{\T}}{\emptyv}}{}}}
    		}
    	\LeftLabel{by \PName{UsumF}}
    	\UC{\blockf{\usum}{\stwo}{\kunit}}
    	\AC{}
    	\LeftLabel{by \PName{X-Termi}}
    	\UC{\sevalfg{\usum}{\emptyv}{\emptyv} \emptyv}
    	\LeftLabel{by \PName{X-Loop}}
    	\BC{\sevalfg{\usum}{\stwo}{\vunit}{\kunit}}
    	\LeftLabel{by \PName{Xducer}}
    	\UC{\seval{\usumdef}{\sgm}{\vunit}{\sgm[\s_0 \|-> \kunit]}}
    }$$


    So $\sgm_0 = \sgm[\s_0 \|-> \kunit]$.\\

	Similarly, with  $\sgm(\s_b) = \stwo$ and $\j{\sgm(\s_i') = \singl{n_i}}$ from $\eqref{\eqnum{3}}$, we can build each $\MP_i$ for 
	$\forall i \in \{1,...,j\}$ as follows:\\
	
	\makebox[0.9\textwidth][c]{  
	  \PT{
	  	\AC{ \infer*{\blockf{\distr}{\<\F_2,...,\F_k,\T\'>, \singl{n_i}}{\<\overbrace{ n_i,...,n_i}}^{k-1}\'> } 
	  		{by \ \PName{DistrT} \  \vcenter{\infer {\blockf{\distr}{\singl{\T},\singl{n_i}}{\emptyv}}{}}}
	  	}
	  	\LeftLabel{by \PName{DistrF}}
	  	\UC{\blockf{\distr}{\stwo,\singl{n_i}}{\< \overbrace{n_i,...,n_i}^{k}\'>}}
	  	\AC{}
	  	\LeftLabel{by \PName{X-Termi}}
	  	\UC{\sevalfg{\distr}{\emptyv,\emptyv}{\emptyv} \emptyv}
	  	\LeftLabel{by \PName{X-Loop}}
	  	\BC{\sevalfg{\distr}{\stwo, \singl{n_i}}{\vunit}{\< \overbrace{ n_i,...,n_i}^{k}\'>}}
	  	\LeftLabel{by \PName{Xducer}}
	  	\UC{\seval{\distrdef}{\sgm_{i-1}}{\vunit}{\sgm_{i-1}[\s_i \|-> \< \overbrace{ n_i,...,n_i}^{k}\'>]}}
	  }
  }
  
  So $\forall i \in \{1,...,j\}. \sgm_i= \sgm_{i-1}[\s_i \|-> \< \overbrace{ n_i,...,n_i}^{k}\'>]$.
  
  Thus $\sgm_j = \sgm[\s_0 \|-> \kunit, \s_1 \|-> \kn{1},..., \s_j \|-> \kn{j}]$.\\
	  
% IH --------	
  Now it remains to build $\MP_{j+1}$. \\
  
	Since we have 
	$$\MT_1 = \PT{\AC{\Type{[x \|-> {\tau_1}, x_1 \|-> \int,...,x_j \|-> \int ]}{e_1}{\tau_2}}}$$
	$$(\ME_i = \PT{\AC{\Eval{[x \|-> {v_i}, x_1 \|-> n_1,..., x_j \|-> n_j]}{e_1}{v_i'}}})^k_{i=1} $$
	$$\MC_1 = \PT{\AC{\Trans{[x \|-> {\st_1}, x_1 \|-> s_1,...,x_j \|-> s_j]}{e_1}{\s_0+1+j}{\s_1}{\sfun{p_1}{\st_2}}}}$$
	
	Let $\Gam_1 = [x \|-> {\tau_1}, x_1 \|-> \int,...,x_j \|-> \int ], 
	\rho_i= [x \|-> {v_i}, x_1 \|-> n_1,..., x_j \|-> n_j]$ 
	and $\del_1 = [x \|-> {\st_1}, x_1 \|-> s_1,...,x_j \|-> s_j]$. 
	
   For $\forall i \in \{1,...,k\}$, we show the following three conditions, which allows us to use IH with $\MT_1$, $\ME_i$, $\MC_1$ later. 
	\begin{enumerate}[(a)]
		\item $\forall x \in dom(\Gam_1). \Type{}{\rho_i(x)}{\Gam_1(x)$ } 
		\item $\forall x \in dom(\Gam_1). \ol{\del_1(x)} \.< \s_0 +1 +j  $
		\item $\forall x \in dom(\Gam_1). \ValRep{\rho_i(x)}{\Gam_1(x)}{\sgm_{ji}(\del_1(x))}$\\
	\end{enumerate}
	
	TS: (a) \\
		From $\eqref{\eqnum{20}}$ and $\eqref{\eqnum{2}}$ it is clear that 
		$$\forall x \in dom(\Gam_1). \Type{}{\rho_i(x)}{\Gam_1(x)}$$ 
		
	TS: (b) \\ 
	    From $\eqref{\eqnum{21}}$, it is clear that 
		$\ol{\del_1(x)} = \ol{\st_1}\.< \s_0 + 1 + j$.
		From $\eqref{\eqnum{1}}$, for $\forall i \in \{1,..,j\}.\del_1(x_i) = \s_0 +i < \s_0 +1 +j$.
		Therefore, $$\forall x \in dom(\Gam_1).  \ol{\del_1(x)} \.< \s_0 +1 +j$$ 
		
	TS: (c) \\	
		For $\forall i \in \{1,..,k\}$, we take $\sgm_{ji} \~\S \sgm_j$
		where $\S = dom(\sgm_j) - (\ol{\st_1} \cup \{\s_1,...,\s_j\})$,  
		such that 
		\begin{align*}
			\sgm_{ji}(\st_1) & = w_i \\
			\sgm_{ji}(\s_1) & = \singl{n_1} \\
			& \vdots \\
			\sgm_{ji}(\s_j) & = \singl{n_j} 
		\end{align*}
		
		It is easy to show that 
		\eq{\eqnum{34}} {\sgm_{j1} \~\S \sgm_{j2} \~\S ... \~\S \sgm_{jk} \~\S \sgm_j}
		\eq{\eqnum{32}}
		{\sgm_{j1} \x\S \sgm_{j2} \x\S ... \x\S \sgm_{jk}= \sgm_j}
		
		Also note that
		\eq{\eqnum{33}}{\Sin = \FV{p_1} \subseteq (\ol{\st_1} \cup \{\s_1,...,\s_j\}) \cap \S = \emptyset} 
		\eq{\eqnum{4}}{\ol{\st_2} \subseteq (\ol{\st_1} \cup \{\s_1,...\s_j\} \cup \dv{p_1}) \cap \S = \emptyset}
				
		From $\MR_i$ in \eqref{comp-ass-valrep} we have
		$\ValRep{\rho_i(x)}{\Gam_1(x)}{\sgm_{ji}(\del_1(x))}$
		
		 and it is clear that 
		 \begin{align*}
		 	\ValRep{\rho_i(x_1)}{\Gam_1(x_1)}{& \sgm_{ji}(\del_1(x_j))} \\
		 	& \vdots \\
		 	\ValRep{\rho_i(x_j)}{\Gam_1(x_j)}{& \sgm_{ji}(\del_1(x_j))}
		 \end{align*}
		Therefore, 
		$\forall x \in dom(\Gam_1). \ValRep{\rho_i(x)}{\Gam_1(x)}{\sgm_{ji}(\del_1(x))}.$

	Then by IH ($k$ times) on $\MT_1$ with $\ME_i$, 
	$\MC_1$ we obtain the following result:
	\eq{compIH1}{(\seval{p_1}{\sgm_{ji}}{\<()\'>}{\sgm_{ji}'})^k_{i=1}}
	\eq{compIH2}{(\ValRep{v'_i}{\tau_2}{\sgm_{ji}'(\st_2)})^k_{i=1}}
	\eq{compIH3}{(\sgm_{ji}' \ConEq{\s_0 +j+1} \sgm_{ji})^k_{i=1}}
	\eq{compIH4}{\s_0+1+j \le \s_1}
	\eq{compIH5}{\ol{\st_2} {\.<} \s_1}
% ----------- 	


	Assume $\Sout = \{\s_{j+1},...,\s_{j+l}\}$.(Note here $\s_{j+i}$ is not necessary equal to $\s_j + i$, but must be $\ge \s_j$). \\
	
	There are two possibilities for $\MP_{j+1}$:
	\begin{itemize}
%subcase k= 0
	\item 
	Subcase $\sgm_j(\s_0) = \emptyv$, i.e., $k = 0$.\\
	Then $\j{\sgm_j(\s_i) = \emptyv}$. Also, with (3.4) and (3.5), we have 
	$\forall s \in \ol{\st_1}. \sgm_j(\s) = \emptyv$; 
	with (3.6), $\sgm_j(\s_b) = \oT $.
	Thus $$\forall s \in (\{\s_0\} \cup \Sin). \sgm_j(\s) = \emptyv$$ 
	
	Then we can use the rule $\PName{Wc-Emp}$ to build $\MP$ as follows:
	$$\PT{
		\Axiom{\seval{\wcdef}{\sgm_j}{\< () \'>}
			   {\sgm_j[\l{\s_{j+i} \|-> \emptyv}]}}
	  }$$ 
    So in this subcase, we take \eq{\eqnum{5}}{
    \sgm' = \sgm_j[\l{\s_{j+i} \|-> \emptyv}] = \sgm[\s_0 \|-> \emptyv, \s_1 \|-> \emptyv, ..., \s_{j+l} \|-> \emptyv]}
	
	TS: (viii)
	\def\sgmpempty{\sgm[\s_0 \|-> \emptyv, \s_1' \|-> \emptyv, ..., \s_j' \|-> \emptyv]}

% vi	
	Since $k=0$, then $v = \{ \}$. Also, we have 
	$$\sgm'(\s_b) = \sgm(\s_b) = \oT$$
	$$\forall s \in \ol{\st_2}. \sgm'(s) = \emptyv$$ 
	
	Therefore, $\sgm'((\st_2,\s_b)) = (\sgm'(\st_2), \sgm'(\s_b))$, with which we construct 
	$$\MR = 
	\PT{\Axiom{\ValRep{\{\}}{\tseq{\tau_2}}{((...(\emptyv),...),\oT)}}}$$ 
	as required.\\
    
%subcase k > 0	
\def\sgmp-nonempty{\sgm[\s_0 \|-> \kunit, \s_1' \|-> \sgm''(\s'_1),...,
	\s'_j \|-> \sgm''(\s'_j)]}  

	\item \label{subcase-2} 
	Subcase $\sgm_j(\s_0) = \<()|...\'>$, i.e., $k > 0$.
	
    Since we have $\eqref{\eqnum{34}}$, $\eqref{compIH1}$ and  $\FV(p_1) \cap \S = \emptyset$ from $\eqref{\eqnum{33}}$,
	it is easy to show that using Lemma \ref{lem-sgm-join} at most (k-1) times we can obtain
	\eq{p1-sgms-sgms'}{
		\seval{p_1}{(\x{\S} \sgm_{ji})^k_{i=1}}{\kunit}{(\x{\S} \sgm_{ji}')^k_{i=1}}
	}

    Let $\sgm'' = (\x{\S} \sgm_{ji}')^k_{i=1}$. Also with $\eqref{\eqnum{32}}$, we replace both the start and ending stores in $\eqref{p1-sgms-sgms'}$, giving us 
    a derivation $\MP_{j+1}'$ of
    $$\seval{p_1}{\sgm_j}{\kunit}{\sgm''}$$
	
    Now we build $\MP_{j+1}$ using the rule $\PName{Wc-Nonemp}$ as follows:
	$$\PT{
		\UCN{\MP_{j+1}'}{\seval{p_1}{\sgm_j}{\kunit}{\sgm''}}
		\UC{\seval{\wcdef} {\sgm_j}{\vunit} 
			{\sgm_j[\l{\s_{j+i}\|-> \sgm''(\s_{j+i})}]}}
	}$$
   
    So in this subcase we take 
   \eq{\eqnum{6}}
   	{\begin{aligned}
	 \sgm' & = \sgm_j[\l{\s_{j+i}\|-> \sgm''(\s_{j+i})}] \\
          & = \sgm[\s_0 \|-> \kunit,  \s_1 \|-> \kn{1},..., \s_j \|-> \kn{j},\\ 
          & \qquad \s_{j+1} \|-> \sgm''(\s_{j+1}),..., \s_{j+l} \|-> \sgm''(\s_{j+l})]
   		\end{aligned}
   		}\\
    
	TS : (viii)  \\
	Let $\sgm'(\st_2) = w'$, and $\sgm_{ji}'(\st_2) = w'_i$. 
	 
	For $\forall i \in \{1,...,k\}$, by Definition \ref{def-sgm-join} with $\eqref{\eqnum{4}}$, we get
	$$w' = \sgm''(\st_2) = w'_1 {\++} ... {\++} w'_k$$
	Also, $\sgm'(\s_b) = \sgm(\s_b) = \stwo$,
	we now have $\sgm'((\st_2,\s_b)) = (\sgm'(\st_2),\sgm'(\s_b)) = (w',\stwo)$. 
	With \eqref{compIH2}, we can construct $\MR$ as follows:
	$$\PT{
		\AC{(\ValRep{v'_i}{\tau_2}{w'_i})^k_{i=1}}
		\UC{\ValRep{\Seqk{v'}}{\tseq{\tau_2}}{(w',\stwo)}}
	}$$ as required. \\

	\end{itemize}

%vii
\item TS:  $\sgm' \ConEq{\s_0} \sgm$ \\ \\
	Since $\forall \s \in \{\s_0\} \cup \{\s_1,...,\s_j\} \cup \{\s_{j+1},...,\s_{j+l}\}. \s \ge \s_0$,
	with $\eqref{\eqnum{5}}$ and $\eqref{\eqnum{6}}$, it is clear
	$\forall s < s_0. \sgm'(s) = \sgm(s)$,
	i.e., $\sgm' \ConEq{\s_0} \sgm$ as required.

% viii
	\item TS: $\s_0 \le \s_1$ \\
	From \eqref{compIH4} we immediately get $\s_0 \le \s_1 -1 -j < \s_1$.\\
	
%ix
	\item TS: $\ol{(\st_2,\s_b)} {\.<} \s_1$  \\
	From $\eqref{\eqnum{21}}$ we know $\s_b < \s_0$, thus $ \s_b < \s_0 \le \s_1$. 
	And we already have \eqref{compIH5}. Therefore,
	$$\ol{(\st_2,\s_b)} = \ol{\st_2} {\++} [s_b] \.< \s_1.$$
	
	\end{enumerate}

% case variable 
 \item Case $e = x$.\\
 We must have 
 $$\MT = \PT{
 	\AxiomC{}
 	\RiLa{(\Gam(x) = \tau)}
 	\UC{\Type{\Gam}{x}{\tau}}
 }$$
 $$ \ME = 
 \PT{
 	\AxiomC{}
 	\RiLa{(\rho(x)=v)}
 	\UC{\Eval{\rho}{x}{v}}
 }$$
 $$ \MC = 
 \PT{\AC{}
 	\RiLa{(\del(x)= \st)}
 	\UC{\Trans{\del}{x}{\s_0}{\s_0}{\sfun{\epsilon}{\st}}}
 }
 $$
 So $p= \epsilon$. 
 
 Immediately we have $\MP$ =
 $\PT{\Axiom{\seval{\epsilon}{\sgm}{\vunit}{\sgm}}}$\\
 So $\sgm' = \sgm$, which implies $\sgm'  \ConEq{\s_0} \sgm$.\\
 From the assumptions (iv),(v) and(vi) we already have $\ValRep{v}{\tau}{\sgm(\st)}$,
 and $\ol{\st} \.< \s_0$. \\
 Finally it's clear that $\s_0 \le \s_0$, and we are done.
 
 
% case let-binding 
 \item \label{case-let} Case $e = \Let{x}{e_1}{e_2}$. \\[1ex]
 We must have:
 $$\PT{
 	\UCN{\MT_1}{\Type{\Gam}{e_1}{\tau_1}}
 	\UCN{\MT_2}{\Type{\Gam[\Map{x}{\tau_1}]}{e_2}{\tau}}
 	\LeLa{\MT =} 
 	\BC{\Type{\Gam}{\Let{x}{e_1}{e_2}}{\tau}}
 }$$
 
 $$\PT{	
 	\UCN{\ME_1}{\Eval{\rho}{e_1}{v_1}}
 	\UCN{\ME_2}{\Eval{\rho[\Map{x}{v_1}]}{e_2}{v}}
 	\LeLa{\ME =} 
 	\BC{\Eval{\rho}{\Let{x}{e_1}{e_2}}{v}}
 }$$ 
 $$\PT{\UCN{\MC_1}{\Trans{\del}{e_1}{\s_0}{\s_0'}{\sfun{p_1}{\st_1}}}
 	\UCN{\MC_2}{\Trans{\del[x \|-> {\st_1}]}{e_2}{\s_0'}{\s_1}{\sfun {p_2} {\st}}}
 	\LeLa{\MC = }
 	\BC{\Trans{\del}{\Let{x}{e_1}{e_2}}{\s_0}{\s_1}{\sfun {p_1;p_2} {\st}}}
 }$$\\[1ex]
 
 So $p = p_1;p_2$. \\
 
 By IH on $\MT_1$ with $\ME_1,\MC_1$, we get 
 \begin{enumerate}[(a)]
 	\item $\MP_1$ of $\seval{p_1}{\sgm}{\vunit}{\sgm_1}$
 	\item $\MR_1$ of $\ValRep{v_1}{\tau_1}{\sgm_1(\st_1)}$
 	\item $\sgm_1 \ConEq{s_0} \sgm$ 
 	\item $\s_0 \le \s_0'$
 	\item $\ol{\st_1} \.< {s_0'}$
 \end{enumerate}
 
  From (b), we know $\rho[\Map{x}{v_1}](x) : \Gamma[\Map{x}{\tau_1}](x)$ and  $\ValRep{\rho[\Map{x}{v_1}](x)}{\Gamma[\Map{x}{\tau_1}](x)}{\sgm_1(\delta[\Map{x}{\st_1}](x))}$ must hold. 
  From (e), we have $\ol{\delta[\Map{x}{\st_1}](x)} \.< s_0'$. 
 
 Then by IH on  $\MT_2$ with $\ME_2,\MC_2$, we get
 \begin{enumerate}	[(a)]
 	\setcounter{enumi}{5}
 	\item $\MP_2$ of $\seval{p_2}{\sgm_1}{\vunit}{\sgm_2}$ 
 	\item $\MR_2$ of $ \ValRep{\sgm_2}{\tau}{\sgm_2(\st)}$
    \item $\sgm_2 \ConEq{\s_0'} \sgm_1$
    \item $\s_0' \le \s_1$
    \item $\ol{\st} \.< {s_1}$
\end{enumerate}

 So we can construct:  
 $$\PT{
 	\UCN{\MP_1}{\seval{p_1}{\sgm}{\vunit}{\sgm_1}}
 	\UCN{\MP_2}{\seval{p_2}{\sgm_1}{\vunit}{\sgm_2}}
 	\LeLa{\MP = }	
 	\BC{\seval{p_1;p_2}{\sgm}{\vunit}{\sgm_2}}
 }$$

 From (c), (d) and (h), it is clear that $\sgm_2 \ConEq{s_0} \sgm_1 \ConEq{s_0} \sgm$.
 From (d) and (i), $\s_0 \le \s_1$.
 
 Take $\sgm' = \sgm_2$ (thus $\MR$ = $\MR_2$)  and we are done. 
 
 
 \item Case $e = \hcall\Tupk{x}$ \\
 We must have  
 $$\PT{
 	\UCN{\MT_1}{\Typef {\hcall} {\replc{k}{\tau}} {\tau}}
 	\LeLa{\MT = }
 	\RiLa{((\Gam(x_i)= \tau_i)^k_{i=1})}
 	\UC{\Type{\Gam}{\hcall{\Tupk{x}}}{\tau}}
 }$$
 $$\PT{
 	\UCN{\ME_1}{\Eval{}{\EvalF{\Tupk{v}}}{v}}
 	\LeLa{\ME = }
 	\RiLa{((\rho(x_i)=v_i)^k_{i=1})}
 	\UC{\Eval{\rho}{\hcall{\Tupk{x}}}{v}}
 }$$
 $$\PT{
 	\UCN{\MC_1}{\Transf{\hcall}{\replc{k}{st}}{\s_0}{\s_1}{\sfun{p}{\st}}}
    \LeLa{\MC =}
 	\RiLa{((\del(x_i)=\st_i)^k_{i=1})}
 	\UC{\Trans{\del}{\hcall \Tupk{x}}{\s_0}{\s_1}{\sfun{p}{\st}}}
 }$$
 
 From the assumptions (iv),(v) and (vi), for all $i \in \{1,...,k\}$:
 \begin{enumerate}[(i)]
 	\setcounter{enumi}{3}
 	\item $\Type{}{\rho(x_i)}{\Gam(x_i)}$, that is, $\Type{}{v_i}{\tau_i}$
 	\item $\ol{\del(x_i)} \.< \s_0$, that is, $\ol{\st_i} \.< \s_0$
 	\item $\ValRep{\rho(x_i)}{\Gam(x_i)}{\sgm(\st_i)}$, that is,
 	$\ValRep{v_i}{\tau_i}{\sgm(\st_i)}$
 \end{enumerate}
 
 So using Lemma \ref{function-correctness} on $\MT_1,\ME_1, \MC_1, (a),(b)$ and (c) gives us exactly what we shall show.
 	
	\end{itemize}	
\end{proof}


