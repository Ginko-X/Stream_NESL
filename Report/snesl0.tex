\def\s{\mathit{s}}  
\def\st{\mathit{st}} 

\def\v{\vec v}
\def\a{\vec a}
\def\b{\vec b}

%\def\vec#1{\overrightarrow{#1}}
\def\unit{()}

\def\ra{\rightarrow}

\def\vrange#1#2{\langle #1,...,#2 \rangle}
\def\lrange#1#2{\left[ #1,...,#2 \right]}

\def\emptyv{\langle \rangle}

\def\phi{\varphi}

\def\ctrl{\mathtt{Ctrl}}
\def\consta#1{\mathtt{Const_{#1}}} 
\def\toflag{\mathtt{ToFlags}}
\def\usum{\mathtt{Usum}}
\def\maptwo{\mathtt{MapTwo}}
\def\scan{\mathtt{ScanPlus}}
\def\sdef#1#2{#1 := #2}
\def\withctrl#1#2#3{#3 := \mathtt{WithCtrl}(#1,#2)}

\def\T{\mathtt{T}} 
\def\F{\mathtt{F}} 
\def\oT{\singl{\T}}
\def\oF{\singl{\F}}

\def\tail#1{\mathtt{tail}(#1)} 

\def\appop{\operatorname{++}}
\def\vapp#1#2{#1 \appop #2}

\def\seval#1#2#3#4{\langle #1,#2 \rangle \Eva^{#3} #4} 
\def\sevalf#1#2#3#4{SEva_{\phi}(#1,...,#2) \Eva^{#3} #4} 
\def\block#1#2#3{Block_{\phi}(#1,...,#2) \Downarrow #3}  
\def\unary#1#2#3{Unary_{\phi}(#1,...,#2) \Downarrow #3}
\def\da{\Downarrow}

\def\blockv#1#2#3#4{Block_{\phi,#4}(#1,...,#2) \Downarrow #3}  
\def\unaryv#1#2#3#4#5{Unary_{\phi,#4}(#1,...,#2) \Downarrow^{#5} #3}



\def\singl#1{\langle #1 \rangle}
\def\Maps#1#2{#1 \rightarrowtail #2}
\def\xR#1#2{\xRightarrow[#1]{#2}}


%translation
\def\sfun#1#2{(#1,#2)}
\def\tranf#1#2#3#4#5{\Env Trans_\phi(#1,...,#2) \xRightarrow[#4]{#3} #5}  

\providecommand{\versionnumber}{0.0.2}


\section{Level-0}
Draft version \versionnumber

\subsection{Source language syntax}
(Ignore empty sequence for now)\\
Expressions:
$$e ::= x \ | \ \Let{x}{e_1}{e_2} \ | \ \hcall{\Tupk{x}} \ | \ \Comp{e}{x}{y}{\cdot} $$
$$\hcall = \*{const}_n \ | \ \*{iota} \ | \ \*{plus} $$ 

Values: \\
$$ n \in \*{Z} $$
$$ v::= n \ | \ \Seqk{v}$$

\subsection{Type system}
$$\tau ::= \int | \tseq{\tau_1}$$

Type environment $\Gamma = [\Map{x_1}{\tau_1}, ..., \Map{x_i}{\tau_i} ]$.
\begin{itemize}

\item \Jug{\Type{\Gam}{e}{\tau}}

\PT{
	\AxiomC{}
	\RiLa{(\Gam(x) = \tau)}
    \UC{\Type{\Gam}{x}{\tau}}
}
\PT{
	\AC{\Type{\Gam}{e_1}{\tau_1}}
	\AC{\Type{\Gam[\Map{x}{\tau_1}]}{e_2}{\tau}}
	\BC{\Type{\Gam}{\Let{x}{e_1}{e_2}}{\tau}}
}\\[1ex]


\PT{
	\AC{\Type{}{\TypeF{\Tupk{\tau}}}{\tau}}
	\RiLa{((\Gam(x_i)= \tau_i)^k_{i=1})}
	\UC{\Type{\Gam}{\hcall{\Tupk{x}}}{\tau}}
}
\PT{
	\AC{\Type{\Gam[\Map{x}{\tau_1}]}{e}{\tau}}
	\RiLa{(\Gam(y)=\tseq{\tau_1})}
	\UC{\Type{\Gam}{\Comp{e}{x}{y}{\cdot}}{\tseq{\tau}}}
}\\[2ex]


\item Auxiliary \Jug{\Type{}{\TypeF\Tupk{\tau}}{\tau}}

\PT{\Axiom{\Type{}{\const{n}}{\int}}}
\PT{\Axiom{\Type{}{\iota{\int}}{\tseq{\int}}}}
\PT{\Axiom{\Type{}{\plus{\int}{\int}}{\int}}}


\end{itemize}

\subsection{Source language semantics}
\begin{itemize}

\item \Jug{\Eval{\rho}{e}{v}}
\PT{
	\AxiomC{}
	\RiLa{(\rho(x)=v)}
	\UC{\Eval{\rho}{x}{v}}
}
\PT{
	\AC{\Eval{\rho}{e_1}{v_1}}
	\AC{\Eval{\rho[\Map{x}{v_1}]}{e_2}{v}}
	\BC{\Eval{\rho}{\Let{e_1}{x}{e_2}}{v}}	
}\\[1ex]

\PT{
	\AC{\Eval{}{\EvalF{\Tupk{v}}}{v}}
	\RiLa{((\rho(x_i)=v_i)^k_{i=1})}
	\UC{\Eval{\rho}{\hcall{\Tupk{x}}}{v}}
}
\PT{
	\AC{(\Eval{[\Map{x}{v_i}]}{e}{v_i'})^k_{i=1}}
	\RiLa{(\rho(y)=\Seqk{v})}
	\UC{\Eval{\rho}{\Comp{e}{x}{y}{\cdot}}{\Seqk{v'}}}
}\\[1ex]

\item Auxiliary \Jug{\Eval{}{\EvalF{\Tupk{v}}}{v}}

\PT{\Axiom{\Eval{}{\const{n}}{n}}}
\PT{\Axiom{\Eval{}{\iota{n}}{\{0,1,...,n-1\}}}}
\PT{\AC{} 
	\RiLa{(n_3= n_1+n_2)} 
	\UC{\Eval{}{\plus{n_1}{n_2}}{n_3}}}

\end{itemize}

\subsection{SVCODE syntax}
Stream id: $$\s \in \*{N} = \{0,1,2...\}$$
Stream tree: $$ \st ::= \s \ | \ (\st_1,\s) $$
SVCODE expressions: $$\varphi ::= \ctrl \ | \ \consta{a} \ | \ \toflag
\ | \ \usum \ | \ \maptwo \ | \ \scan $$

SVCODE program: 
\begin{align*}
	p ::= & \ \epsilon \\
	     &| \ \sdef{\s}{\psi(s_1,...,s_i)} \\
	     &| \ \withctrl{\s}{p}{\st} \\
	     &| \ p_1;p_2 	 
\end{align*}
%$$ p ::= \epsilon \ | \ \s:= \psi(s_1,...,s_i) \ | \  \withctrl{\s}{p}{\st} \ | \ p_1;p_2 $$

Target language values: 
$$b \in \{\T,\F \}$$
$$a ::= n \ | \ b \ | \ \unit$$
$$\b = \vrange{b_1}{b_i}$$ 
$$\a = \vrange{a_1}{a_i}  $$
$$\v ::= \a \ | \ (\v,\b) $$

Define some operations for convenience:
\begin{itemize}
	\item $\appop: \v \ra  \v \ra \v$ \\
	  $\vapp {\vrange{a_1}{a_i}} {\vrange{a_2}{a_j}} = \langle \a_1,...,a_i,a_2,...,a_j \rangle $ \\
	  $\vapp{(\v_1,\b_1)}{(\v_2,\b_2)} = (\vapp{\v_1}{\v_2}, \vapp{\b_1}{\b_2})$
	\item $\texttt{tail}: \a \ra \a$ \\
	      $\tail{\langle a_1, a_2,...,a_i \rangle} = \vrange{a_2}{a_i}$
\end{itemize}


\subsection{SVCODE semantics}

% TODO add definition for empty streams mapping
% TODO define sids


$\sgm = [\Map{\s_1}{\a_1},...,\Map{\s_i}{\a_i}]$ \\
$\a_c$ is the control stream.
\begin{itemize}

\item \Jug{\seval{p}{\sgm}{\a_c}{\sgm'}}

\PT{\Axiom{\seval{\epsilon}{\sgm}{\a_c}{\sgm}}}
\PT{\AC{\sevalf{\a_1}{\a_k}{\a_c}{\a}}
	\RiLa{((\sgm(\s_i) = \a_i)^k_{i=1})}
	\UC{\seval{\sdef{\s}{\phi\Tupk\s}}{\sgm}{\a_c}{\sgm[\Map{\s}{\a}]}}
} \\[2ex]

\PT{
	\AC{}
	\RiLa{(\sgm(\s)= \emptyv)}
	\UC{\seval{\withctrl{\s}{p}{\st}}{\sgm}{\a_c}{\sgm[\Maps{\st}{\emptyv}]}}
}\\[2ex]

\PT{
	\AC{\seval{p}{\sgm}{\a_s}{\sgm'}}
	\RiLa{(\sgm(\s)= \a_s = \vrange {a_1} {a_i})}
	\UC{\seval{\withctrl s p \st } \sgm {\a_c} \sgm'}
}\\[2ex]

\PT{
	\AC{\seval{p_1}{\sgm}{\a_c}{\sgm''}}
    \AC{\seval{p_2}{\sgm''}{\a_c}{\sgm'}}	
    \BC{\seval{p_1;p_2}{\sgm}{\a_c}{\sgm'}}
}


\item Auxiliary \Jug{\sevalf{\a_1}{\a_k}{\a_c}{\a}}

\PT{
	\AC{\block{\a_{11}}{\a_{k1}}{\a_1}}
	\AC{\sevalf{\a_{12}}{\a_{k2}}{\tail{\a_c}}{\a_2}}
	\RiLa{(\a = \vapp{\a_1}{\a_2})}
	\BC{\sevalf{\vapp{\a_{11}}{\a_{12}}}{\vapp{\a_{k1}}{\a_{k2}}}{\a_c}{\a}}
}\\[2ex]
	
\PT{\Axiom{\sevalf {\a_1} {\a_k} \emptyv \emptyv}}
	

\item Auxiliary \Jug{\block{\a_1}{\a_k}{\a}}

\PT{\Axiom{ \consta{a} \da \singl{a}}}
\PT{\Axiom{\toflag(\singl{n}) \da \langle \F_1,...,\F_n,\T \rangle}}
\PT{\AC{}
	\RiLa{(n_3= n_1+n_2)}
	\UC{\maptwo(\singl{n_1}, \singl{n_2}) \da \singl{n_3}}
} \\

\PT{
	\AC{\unary{\singl \F}{\a_{k1}}{\a_1}}
	\AC{\block{\a_{12}}{\a_{k2}}{\a_2}}
	\RiLa{(\a = \vapp{\a_1}{\a_2})}
	\BC{\block{\vapp {\singl\F} {\a_{12}}} {\vapp {\a_{k1}} {\a_{k2}}}{\a}}
}\\[2ex]

\PT{
	\AC{\unary{\oT} {\a_k}{\a}}
	\UC{\block{\oT}{\a_k} \a}
}\\[2ex]

\PT{
	\AC{\unaryv{\singl \F}{\a_{k1}}{\singl{n_1}} {n_0} {n_0'}}
	\AC{\blockv{\a_{12}}{\a_{k2}}{\a_2}{n_0'}}
	\BC{\blockv{\vapp {\singl\F} {\a_{12}}} {\vapp {\a_{k1}} {\a_{k2}}}{\vapp {\singl{n_1}} {\a_2}} {n_0}}
}\\[2ex]

\PT{
	\AC{\unaryv \oT {\a_k} {\singl{n_1}} {n_0} {}}
	\UC{\blockv{\oT}{\a_k} {\singl{n_1}} {n_0}}
}




\item Auxiliary \Jug{\unary{\singl b}{\a_k}{\a}}

\PT{ \Axiom{\usum(\oF) \da \singl\unit}}
\PT{\Axiom{\usum(\oT) \da \emptyv }} \\[1ex]

\PT{\Axiom{\scan_{n_0}(\oF,{\singl{n}}) \da^{n_0+n} {\singl{n_0}} 
	}}
\PT{\Axiom{\scan_{n_0}(\oT, \emptyv) \da {\singl{n_0}} }}

\end{itemize}


\subsection{Translation}
$\del = [\Map{x_1}{\st_1},..., \Map{x_i}{\st_i}] $

\begin{itemize}	
\item (??not necessary) \\
\PT{
	\AC{\Trans{\del}{e}{\s_0+1}{\s_1}{\sfun p {\st}}}
	\UC{\Trans{\del}{e}{\s_0}{\s_1}{\Talet{\sdef{\s_0}{\ctrl};p}{\st}}}
}\\[2ex]

\item \Jug{\Trans{\del}{e}{\s_0}{\s_1}{\sfun{p}{\st}}}

\PT{\AC{}
	\RiLa{(\del(x)= \st)}
	\UC{\Trans{\del}{x}{\s_0}{\s_0}{\sfun{\epsilon}{\st}}}
}
\PT{\AC{\Trans{\del}{e_1}{\s_0}{\s_0'}{\sfun{p_1}{\st_1}}}
	\AC{\Trans{\del[\Map{x}{\st_1}]}{e_2}{\s_0'}{\s_1}{\sfun {p_2} {\st}}}
	\BC{\Trans{\del}{\Let{x}{e_1}{e_2}}{\s_0}{\s_1}{\sfun {p_1;p_2} {\st}}}
}

\PT{
	\AC{\tranf{\st_1}{\st_k}{\s_0}{\s_1}{\sfun{p}{\st}}}
	\RiLa{((\del(x_i)=\st_i)^k_{i=1})}
	\UC{\Trans{\del}{\phi \Tupk{x}}{\s_0}{\s_1}{\sfun{p}{\st}}}
}

\PT{
	\AC{\Trans{[\Map{x}{\st_1}]}{e}{\s_0+1}{\s_1}{\sfun{p}{\st}}}
	\RiLa{(\del(y)=(\st_1,\s_2))}
	\UC{\Trans{\del}{\Comp{e}{x}{y}{\cdot}}{\s_0}{\s_1}{\sfun{\sdef{\s_0}{\usum(\s_2)}; \withctrl{\s_0}{p}{\st}}{(\st,\s_2)}}}
}


\item Auxiliary \Jug{\tranf{\st_1}{\st_k}{\s_0}{\s_1}{\sfun{p}{\st}}}

\PT{
	\Axiom{\const{a} \xR{\s_0+1}{\s_0}
		\sfun{\sdef{\s_0}{\consta{a}}}{\s_0}  }
} \\ [6ex]

\PT{
	\AC{}
	\RiLa{\left( \begin{aligned}
		  \s_{i+1} & = \s_i + 1 \\
		  p= & \sdef{\s_0}{\toflag(\s)} ; \\ 
		     & \sdef{\s_1}{\usum(s_0)} ; \\
		     & \withctrl{\s_1}{\sdef{\s_2}{\consta{1}}}{\s_2}; \\
	         & \sdef{\s_3}{\scan(\s_0,s_2)}
	    \end{aligned}\right)
    }
	\UC{\iota{\s} \xR{\s_4}{\s_0} {\sfun{p} {(\s_3,\s_0)}}}
}\\[4ex]

\PT{
	\Axiom{\plus{\s_1}{\s_2} \xR{\s_0+1}{\s_0}
	    \sfun{\sdef{\s_0}{\maptwo(\s_1,\s_2)}}{\s_0}}
}


\end{itemize}


\subsection{Value representation}
\begin{itemize}

\item \Jug{\ValRep{v}{\tau}{\v}}

\PT{
	\Axiom{\ValRep{n}{\int}{\singl{n}}}
}
\PT{
	\AC{(\ValRep{v_i}{\tau}{\v_i})^k_{i=1}}
	\RiLa{(\v = \v_1 \appop \v_2 \appop ... \appop \v_k)}
	\UC{\ValRep{\Seqk{v}}{\tseq{\tau}}{(\v,\langle \F_1,..., \F_k, \T \rangle)}}
}
\begin{comment}
\PT{
	\AC{\ValRep {\lrange{v_1}{v_k}} {\tau} {\v}}
	\UC{\ValRep {\Seqk{v}}{\tseq{\tau}}{(\v,\langle \F_1,..., \F_k, \T \rangle)}}
}\\[4ex]

\item \Jug{\ValRep{\lrange{v_1}{v_k}}{\tau}{\v}}
\PT{
	\Axiom{\ValRep{\lrange{n_1}{n_k}}{\int}{\vrange{n_1}{n_k}}}
}
\PT{
	\AC{\ValRep{v_i}{\tau}{\v}}
	\UC{\ValRep{\lrange{v_1}{v_k}}{\tseq{\tau}}{}}
}

\end{comment}

\end{itemize}


\subsection{Correctness proof}
\begin{lem}
	If 
	\begin{enumerate}[(i)]
	\item $\Type{}{\TypeF{\Tupk{\tau}}}{\tau}$
	\item $\Eval{}{\EvalF{\Tupk{v}}}{v}$
	\item $\tranf{\st_1}{\st_k}{\s_0}{\s_1}{\sfun{p}{\st}}$
	\end{enumerate}
 	then 
 	\begin{enumerate}[(i)]
 		\item $\seval{p}{\sgm}{\a_c}{\sgm'}$ (by $\MP$)
 		\item $\ValRep{v}{\tau}{\sgm(\st)}$ (by $\MV$)
 		\item $\sgm' \ConEq{s_0} \sgm $
 		\item $sids(\st) \SetLe \s_1$
 		\item $\s_0 \le \s_1$
 	\end{enumerate}
\end{lem}


\begin{thm}
	If 
	\begin{enumerate}[(i)]
		\item $\Type{\Gam}{e}{\tau}$ (by some derivation $\MT$)
		\item $\Eval{\rho}{e}{v}$ (by $\ME$) 
		\item $\Trans{\del}{e}{\s_0}{\s_1}{\sfun{p}{\st}}$ (by $\MC$)
		\item $\forall x \in dom(\Gam).\rho(x):\Gam(x) \wedge sids(\del(x)) \SetLe \s_0  \wedge  \ValRep{\rho(x)}{\Gam(x)}{\sgm(\del(x))}$
	\end{enumerate}
	then 
	\begin{enumerate}[(i)]
		\item $\seval{p}{\sgm}{\a_c}{\sgm'}$ (by $\MP$)
		\item  $\ValRep{v}{\tau}{\sgm(\st)}$ (by $\MV$)
		\item $\sgm' \ConEq{s_0} \sgm $
		\item  $sids(\st) \SetLe \s_1$
		\item $\s_0 \le \s_1$
	\end{enumerate} 
\end{thm}

