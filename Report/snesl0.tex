\def\s{\mathit{s}}  
\def\st{\mathit{st}} 
\def\SId{\mathbf{SId}}
\def\STree{\mathbf{STree}}

\def\<{\langle} 
\def\'>{\rangle}

\def\->{\rightarrow}
\def\=>{\Rightarrow}
\def\prefix {\sqsubseteq}


\def\v{w}
\def\a{\vec a}
\def\b{\vec b}

\def\unit{()}
\def\vunit{\langle () \rangle}

\def\vrange#1#2{\langle #1,...,#2 \rangle}
\def\lrange#1#2{\left[ #1,...,#2 \right]}

\def\emptyv{\langle \rangle}

\def\SVal{\mathbf{SVal}}

\def\ctrl{\mathtt{Ctrl}}
\def\consta#1{\mathtt{Const_{#1}}} 
\def\toflag{\mathtt{ToFlags}}
\def\usum{\mathtt{Usum}}
\def\maptwo#1{\mathtt{MapTwo}_{#1}}
\def\scan{\mathtt{ScanPlus}}
\def\sdef#1#2{#1 := #2}
\def\withctrl#1#2#3{#3 := \mathtt{WithCtrl}(#1,#2)}

\def\T{\mathtt{T}} 
\def\F{\mathtt{F}} 
\def\oT{\singl{\T}}
\def\oF{\singl{\F}}

\def\tail#1{\mathtt{tail}(#1)} 
\def\sids#1{\mathtt{sids}(#1)}

\def\++{+\!+}
\def\vapp#1#2{#1 {\++} #2}


\def\~#1{\stackrel{#1}{\sim}}
\def\x#1{\stackrel{#1}{\bowtie}} % sgm append



\def\lcall{\psi} 
\def\seval#1#2#3#4{\langle #1,#2 \rangle \Eva^{#3} #4} 
\def\sevalf#1#2#3#4{{\lcall}(#1,...,#2) \Eva^{#3} #4}

\def\block#1#2#3{{\lcall}(#1,...,#2) \Downarrow #3}  

\def\da{\Downarrow}
\def\dda{\downdownarrows}
\def\unary#1#2#3{{\lcall}(#1,...,#2) \dda #3}

\def\blockv#1#2#3#4{\lcall_{#1}(#2,...,#3) \Downarrow #4}  
\def\unaryv#1#2#3#4#5{\lcall_{#1}(#2,...,#3) \dda^{#4} #5}



\def\singl#1{\langle #1 \rangle}
\def\|->{\mapsto}   % map 
\def\>->{\rightarrowtail} % map a bunch of variables

\def\>->#1#2{#1 \rightarrowtail #2}
\def\=>#1#2{\xRightarrow[#2]{#1}}


%translation
\def\sfun#1#2{(#1,#2)}
\def\tranf#1#2#3#4#5{\Env {\hcall}(#1,...,#2) \=>{#3}{#4} #5}  


\newcommand{\eq}[2]{\begin{equation}\label{#1} #2\end{equation}}

\providecommand{\versionnumber}{0.0.4}


\section{Level-0}

Draft version \versionnumber: added the proof of the main correctness theorem (in process)

\subsection{Source language syntax}
(Ignore empty sequence for now)\\
Expressions:
$$e ::= x \ | \ \Let{x}{e_1}{e_2} \ | \ \hcall{\Tupk{x}} \ | \ \Comp{e}{x}{y}{\cdot} $$
$$\hcall = \*{const}_n \ | \ \*{iota} \ | \ \*{plus} $$ 

Values: \\
$$ n \in \*{Z} $$
$$ v::= n \ | \ \Seqk{v}$$

\subsection{Type system}
$$\tau ::= \int | \tseq{\tau_1}$$

Type environment $\Gamma = [x_1 \|-> \tau_1, ..., x_i \|-> {\tau_i} ]$.
\begin{itemize}

\item Expression typing rules:\\

 \Jug{\Type{\Gam}{e}{\tau}}

\PT{
	\AxiomC{}
	\RiLa{(\Gam(x) = \tau)}
    \UC{\Type{\Gam}{x}{\tau}}
}
\PT{
	\AC{\Type{\Gam}{e_1}{\tau_1}}
	\AC{\Type{\Gam[x \|-> \tau_1]}{e_2}{\tau}}
	\BC{\Type{\Gam}{\Let{x}{e_1}{e_2}}{\tau}}
}\\[1ex]


\PT{
	\AC{\Type{}{\TypeF} {\Tupk{\tau} \-> \tau}}
	\RiLa{((\Gam(x_i)= \tau_i)^k_{i=1})}
	\UC{\Type{\Gam}{\hcall{\Tupk{x}}}{\tau}}
}
\PT{
	\AC{\Type{[x \|-> {\tau_1}]}{e}{\tau}}
	\RiLa{(\Gam(y)=\tseq{\tau_1})}
	\UC{\Type{\Gam}{\Comp{e}{x}{y}{\cdot}}{\tseq{\tau}}}
}\\[2ex]


\item Auxiliary \Jug{\Type{}{\TypeF} {\Tupk{\tau} \-> \tau}}

\PT{\Axiom{\Type{}{\*{const}_n}{\int}}}
\PT{\Axiom{\Type{}{\*{iota}}{\int \-> \tseq{\int}}}}
\PT{\Axiom{\Type{}{\*{plus}}{(\int, \int) \-> \int}}}

% value types
\item Value typing rules: \\

\Jug{\Type{}{v}{\tau}}

\PT{\Axiom{\Type{}{n}{\int}}}
\PT{
	\AC{(\Type{}{v_i}{\tau})^k_{i=1}}
	\UC{\Type{}{\Seqk{v}}{\tseq{\tau}}}
}

\end{itemize}

\subsection{Source language semantics}
$ \rho = [x_1 \|-> v_1,...,x_i \|-> v_i]$ \\
\begin{itemize}
\item \Jug{\Eval{\rho}{e}{v}}
\PT{
	\AxiomC{}
	\RiLa{(\rho(x)=v)}
	\UC{\Eval{\rho}{x}{v}}
}
\PT{
	\AC{\Eval{\rho}{e_1}{v_1}}
	\AC{\Eval{\rho[x \|-> v_1]}{e_2}{v}}
	\BC{\Eval{\rho}{\Let{e_1}{x}{e_2}}{v}}	
}\\[1ex]

\PT{
	\AC{\Eval{}{\EvalF{\Tupk{v}}}{v}}
	\RiLa{((\rho(x_i)=v_i)^k_{i=1})}
	\UC{\Eval{\rho}{\hcall{\Tupk{x}}}{v}}
}
\PT{
	\AC{(\Eval{[x \|-> {v_i}]}{e}{v_i'})^k_{i=1}}
	\RiLa{(\rho(y)=\Seqk{v})}
	\UC{\Eval{\rho}{\Comp{e}{x}{y}{\cdot}}{\Seqk{v'}}}
}\\[1ex]

\item Auxiliary \Jug{\Eval{}{\EvalF{\Tupk{v}}}{v}}

\PT{\Axiom{\Eval{}{\const{n}}{n}}}
\PT{\AC{}
	\RiLa{(n \ge 0)}
	\UC{\Eval{}{\iota{n}}{\{0,1,...,n-1\}}}}
\PT{\AC{} 
	\RiLa{(n_3= n_1+n_2)} 
	\UC{\Eval{}{\plus{n_1}{n_2}}{n_3}}}

\end{itemize}

\subsection{SVCODE syntax}
\begin{enumerate}[(1)]
\item Stream id: $$\s \in \SId = \*{N} = \{0,1,2...\}$$

\item Stream tree: $$ \STree \ni \st ::= \s \ | \ (\st_1,\s) $$
\item SVCODE operations: $$\psi ::= \ctrl \ | \ \consta{a} \ | \ \toflag
\ | \ \usum \ | \ \maptwo{\oplus} \ | \ \scan $$
where $\oplus$ stands for some binary operation on $\int$. \\


\item SVCODE program: 
\begin{align*}
	p :: & = \ \epsilon \\
	     &\ \ | \ \sdef{\s}{\psi(s_1,...,s_i)} \\
	     &\ \ | \ \withctrl{\s}{p}{\st} \\
	     &\ \ | \ p_1;p_2 	 
\end{align*}


\item Target language values: 
$$b \in \{\T,\F \}$$
$$ a ::= n \ | \ b \ | \ \unit$$
$$\b = \vrange{b_1}{b_i}$$ 
$$\a = \vrange{a_1}{a_i}  $$
$$\SVal \ni \v ::= \a \ | \ (\v,\b) $$

\item Some notations and operations:
\begin{itemize}
	\item For some $a_0$ and $\a = \< a_1,...,a_i \'>$, let $\< a_0 | \a \'>  = \< a_0,a_1,...,a_i \'>. $ 

	\item $\++: \SVal \->  \SVal \-> \SVal$ \\
	  $\vapp{\vrange{a_1}{a_i}} {\vrange{a_1'}{a_i'}} = \langle a_1,...,a_i,a_1',...,a_i' \rangle $ \\
	  $\vapp{(\v_1,\b_1)}{(\v_2,\b_2)} = (\vapp{\v_1}{\v_2}, \vapp{\b_1}{\b_2})$

	\item $\texttt{sids}$ is a function that converts a $\st \in \STree$ to a set of $\s \in \SId$: \\
	$\sids{\s} = \{\s\}$ \\
	$\sids{(\st,\s)} = \sids{\st} \cup \{\s\}$ 
   
    \item 
    For some set of $\SId$, $t$, and some $\s \in \SId$, let $t \SetLe \s$ denote $\forall \s' \in t. \s' < \s$.

\end{itemize}

\end{enumerate}

\subsection{SVCODE semantics}

SVCODE runtime environment $\sgm = [\s_1 \|-> {\a_1},...,\s_i \|-> {\a_i}]$.\\
We define some notations and operations related to $\sgm$:
\begin{enumerate}[(1)]
\item Let $\sgm_1 \ConEq{\s} \sgm_2$ denote $\forall \s' < \s. \sgm_1(\s') = \sgm_2(\s')$. \\

\item \Jug{\sgm(\st) = w}
\PT{\Axiom{\sgm(\s) = \a}} 
\PT{
	\AC{\sgm(\st)=w} 
	\Axiom{\sgm(\s) = \a}
	\BC{\sgm((\st,\s)) = (w,\a)}
}

\end{enumerate}

\begin{defi}
	\label{sgm-sim}
	
	$\sgm_1 {\~{\st}} \sgm_2 $
	 iff \\
	\indent (1) $dom(\sgm_1) = dom(\sgm_2)$ \\
	\indent (2) $\forall s \in (dom(\sgm_1) - \sids{st}).\sgm_1(s)= \sgm_2(s)$ \\
\end{defi}

\begin{defi}
	\label{sgm-join}
	
	For some $\sgm_1 \~{\st} \sgm_2$,
	$\sgm_1 \x{\st} \sgm_2 = \sgm$ where 
	$$\sgm(s) =
		\begin{cases}
		\sgm_1(\s) {\++} \sgm_2(s), & s \in \sids{\st} \\
		\sgm_1(s),&  otherwise
		\end{cases} $$ 
\end{defi}

SVCODE operational semantics: \\
\begin{itemize}

\item \Jug{\seval{p}{\sgm}{\a_c}{\sgm'}}
$\a_c$ is the control stream.\\

\PT{\Axiom{\seval{\epsilon}{\sgm}{\a_c}{\sgm}}}
\PT{\AC{\sevalf{\a_1}{\a_k}{\a_c}{\a}}
	\RiLa{((\sgm(\s_i) = \a_i)^k_{i=1})}
	\UC{\seval{\sdef{\s}{\lcall\Tupk\s}}{\sgm}{\a_c}{\sgm[\s \|-> \a]}}
} \\[2ex]

\PT{
	\AC{}
	\RiLa{(\sgm(\s)= \emptyv, \sids{\st} = \{s_1,...,\s_i\})}
	\UC{\seval{\withctrl{\s}{p}{\st}}{\sgm}{\a_c}{\sgm[\s_1 \|-> \emptyv, ..., \s_i \|-> \emptyv]}}
}\\[2ex]

\PT{
	\AC{\seval{p}{\sgm}{\a_s}{\sgm''}}
	\RiLa{\left(
		\begin{aligned} 
		&\sgm(\s)= \a_s = \< a_0 | \a \'> \\
		&\sids{\st}=\{s_1,...,s_i\}
		\end{aligned}\right)}
	\UC{\seval{\withctrl s p \st } \sgm {\a_c} \sgm[\s_1 \|-> \sgm''(\s_1),...,\s_i \|-> \sgm''(\s_i)]}
}\\[2ex]

\PT{
	\AC{\seval{p_1}{\sgm}{\a_c}{\sgm''}}
    \AC{\seval{p_2}{\sgm''}{\a_c}{\sgm'}}	
    \BC{\seval{p_1;p_2}{\sgm}{\a_c}{\sgm'}}
}


\item $Transducer$ semantics: \\

\Jug{\sevalf{\a_1}{\a_k}{\a_c}{\a}} 


\PT{
	\AC{\block{\a_{11}}{\a_{k1}}{\a_1}}
	\AC{\sevalf{\a_{12}}{\a_{k2}}{\a_c}{\a_2}}
	\RiLa{(\a = \vapp{\a_1}{\a_2})}
	\BC{\sevalf{\vapp{\a_{11}}{\a_{12}}}{\vapp{\a_{k1}}{\a_{k2}}}{\< a_0 | \a_c \'>}{\a}}
}\\[2ex]
	
\PT{\Axiom{\sevalf {\a_1} {\a_k} \emptyv \emptyv}}
	

\item Transducer $block$ semantics: \\ 

\Jug{\block{\a_1}{\a_k}{\a}}

\PT{\Axiom{ \consta{a} \da \singl{a}}}
\PT{\Axiom{\toflag(\singl{n}) \da \langle \F_1,...,\F_n,\T \rangle}}
\PT{\AC{}
	\RiLa{(n_3= n_1 \oplus n_2)}
	\UC{\maptwo{\oplus}(\singl{n_1}, \singl{n_2}) \da \singl{n_3}}
} \\

\PT{
	\AC{\unary{\singl \F}{\a_{k1}}{\a_1}}
	\AC{\block{\a_{12}}{\a_{k2}}{\a_2}}
	\RiLa{(\a = \vapp{\a_1}{\a_2})}
	\BC{\block{\vapp {\singl\F} {\a_{12}}} {\vapp {\a_{k1}} {\a_{k2}}}{\a}}
}\\[2ex]

\PT{
	\AC{\unary{\oT} {\a_k}{\a}}
	\UC{\block{\oT}{\a_k} \a}
}\\[2ex]


\item Transducer $unary$ semantics:\\ 

\Jug{\unary{\singl b}{\a_k}{\a}}

\PT{ \Axiom{\usum(\oF) \da \singl\unit}}
\PT{\Axiom{\usum(\oT) \da \emptyv }} \\[1ex]


%loopuv
\item Semantics of transducer block with $accumulator$: \\

\Jug{\blockv{n}{\a_1}{\a_k}{\a}}
\PT{
	\AC{\unaryv{n_0} {\singl \F}{\a_{k1}}{n_0'} {\singl{n_1}}  }
	\AC{\blockv{n_0'}{\a_{12}}{\a_{k2}}{\a_2}}
	\BC{\blockv{n_0} {\vapp {\singl\F} {\a_{12}}} {\vapp {\a_{k1}} {\a_{k2}}}{\vapp {\singl{n_1}} {\a_2}} }
}\\[2ex]

\PT{
	\AC{\unaryv {n_0} \oT {\a_k} {} {\singl{n_1}}}
	\UC{\blockv {n_0} \oT {\a_k} {\singl{n_1}} }
}

\item Semantics of transducer unary with $accumulator$: \\

\Jug{\unaryv{n}{\oF}{\a_k}{n'}{\a}}

\PT{\Axiom{\scan_{n_0}(\oF,{\singl{n}}) \da^{n_0+n} {\singl{n_0}} }} \\

\Jug{\unaryv{n}{\oT}{\a_k}{}{\a}}

\PT{\Axiom{\scan_{n_0}(\oT, \emptyv) \da {\singl{n_0}} }}


\end{itemize}


\begin{thm}[deterministic ??]
	\label{svcode-determ}
	If $\seval{p}{\sgm}{\a_c}{\sgm'}$ and $\seval{p}{\sgm}{\a_c}{\sgm''}$, 
	then $\sgm' = \sgm''$.
\end{thm}

%TODO define \sgm \x \sgm'
\begin{lem}[??] \label{lem-sgm-join}
	If $\sgm_1 \~{\st} \sgm_2$, (!!should have: import(p) = st)
	$\seval{p}{\sgm_1}{\a_1}{\sgm_1'}$, 
	$\seval{p}{\sgm_2}{\a_2}{\sgm_2'}$,
	
	then $\seval{p}{\sgm_1 \x{} \sgm_2}{\a_1 \++ \a_2}{\sgm_1' \x{} \sgm_2'}$
\end{lem}

\begin{defi}
	$\a$ is a $prefix$ of $\a'$ if $\a \prefix \a'$.
\end{defi}
\Jug{\a \prefix \a'}
\PT{\Axiom{\emptyv \prefix \a }}
\PT{
	\AC{\a \prefix \a'}
	\UC{\<a_0 | \a \'> \prefix \<a_0 | \a' \'>}
}


\begin{lem}
	If
	\begin{enumerate}[(i)]
		\item $(\a_i' \prefix  \a_i)^k_{i=1}$ and $\block{\a_1'}{\a_k'}{\a'}$, 
		\item $(\a_i'' \prefix \a_i)^k_{i=1}$ and
		$\block{\a_1''}{\a_k''}{\a''}$
	\end{enumerate} 
	then \begin{enumerate}[(i)]
		\item $(\a_i' = \a_i'')^k_{i=1}$ 
		\item $\a' = \a''$.
	\end{enumerate}
\end{lem}



\subsection{Translation}
$\del = [x_1 \|-> \st_1,..., x_i \|-> {\st_i}] $

\begin{itemize}	

\item \Jug{\Trans{\del}{e}{\s_0}{\s_1}{\sfun{p}{\st}}}

\PT{\AC{}
	\RiLa{(\del(x)= \st)}
	\UC{\Trans{\del}{x}{\s_0}{\s_0}{\sfun{\epsilon}{\st}}}
}
\PT{\AC{\Trans{\del}{e_1}{\s_0}{\s_0'}{\sfun{p_1}{\st_1}}}
	\AC{\Trans{\del[x \|-> {\st_1}]}{e_2}{\s_0'}{\s_1}{\sfun {p_2} {\st}}}
	\BC{\Trans{\del}{\Let{x}{e_1}{e_2}}{\s_0}{\s_1}{\sfun {p_1;p_2} {\st}}}
}

\PT{
	\AC{\tranf{\st_1}{\st_k}{\s_0}{\s_1}{\sfun{p}{\st}}}
	\RiLa{((\del(x_i)=\st_i)^k_{i=1})}
	\UC{\Trans{\del}{\hcall \Tupk{x}}{\s_0}{\s_1}{\sfun{p}{\st}}}
}

\PT{
	\AC{\Trans{[x \|-> {\st_1}]}{e}{\s_0+1}{\s_1}{\sfun{p}{\st}}}
	\RiLa{(\del(y)=(\st_1,\s_2))}
	\UC{\Trans{\del}{\Comp{e}{x}{y}{\cdot}}{\s_0}{\s_1}{\sfun{\sdef{\s_0}{\usum(\s_2)}; \withctrl{\s_0}{p}{\st}}{(\st,\s_2)}}}
}


\item Auxiliary \Jug{\tranf{\st_1}{\st_k}{\s_0}{\s_1}{\sfun{p}{\st}}}

\PT{
	\Axiom{\const{a} \=>{\s_0+1}{\s_0}
		\sfun{\sdef{\s_0}{\consta{a}}}{\s_0}  }
} \\ [6ex]

\PT{
	\AC{}
	\RiLa{\left( \begin{aligned}
		  \s_{i+1} & = \s_i + 1 \\
		  p= & \sdef{\s_0}{\toflag(\s)} ; \\ 
		     & \sdef{\s_1}{\usum(s_0)} ; \\
		     & \withctrl{\s_1}{\sdef{\s_2}{\consta{1}}}{\s_2}; \\
	         & \sdef{\s_3}{\scan(\s_0,s_2)}
	    \end{aligned}\right)
    }
	\UC{\iota{\s} \=>{\s_4}{\s_0} {\sfun{p} {(\s_3,\s_0)}}}
}\\[4ex]

\PT{
	\Axiom{\plus{\s_1}{\s_2} \=>{\s_0+1}{\s_0}
	    \sfun{\sdef{\s_0}{\maptwo{+}(\s_1,\s_2)}}{\s_0}}
}

\end{itemize}


\subsection{Value representation}
\begin{itemize}

\item \Jug{\ValRep{v}{\tau}{\v}}

\PT{
	\Axiom{\ValRep{n}{\int}{\singl{n}}}
}
\PT{
	\AC{(\ValRep{v_i}{\tau}{\v_i})^k_{i=1}}
	\RiLa{(\v = \v_1 \++ \v_2 \++ ... \++ \v_k)}
	\UC{\ValRep{\Seqk{v}}{\tseq{\tau}}{(\v,\langle \F_1,..., \F_k, \T \rangle)}}
}


\begin{comment}
\PT{
	\AC{\ValRep {\lrange{v_1}{v_k}} {\tau} {\v}}
	\UC{\ValRep {\Seqk{v}}{\tseq{\tau}}{(\v,\langle \F_1,..., \F_k, \T \rangle)}}
}\\[4ex]

\item \Jug{\ValRep{\lrange{v_1}{v_k}}{\tau}{\v}}
\PT{
	\Axiom{\ValRep{\lrange{n_1}{n_k}}{\int}{\vrange{n_1}{n_k}}}
}
\PT{
	\AC{\ValRep{v_i}{\tau}{\v}}
	\UC{\ValRep{\lrange{v_1}{v_k}}{\tseq{\tau}}{}}
}

\end{comment}

\end{itemize}

\begin{lem}
	If $\ValRep{v}{\tau}{w}$, $\ValRep{v'}{\tau}{w}$,
	then $v=v'$.
\end{lem}


\subsection{Correctness proof}
\begin{lem}
	\label{function-correctness}
	If 
	\begin{enumerate}[(i)]
	\item $\Type{} {\TypeF} {\Tupk{\tau} \-> \tau}$
	\item $\Eval{}{\EvalF{\Tupk{v}}}{v}$
	\item $\tranf{\st_1}{\st_k}{\s_0}{\s_1}{\sfun{p}{\st}}$
 	\item $(\ValRep{v_i}{\tau_i}{\st_i})^k_{i=1}$
 	\item $\bigcup^k_{i=1}\sids{\st_i} \SetLe \s_0$
	\end{enumerate}
 	then 
 	\begin{enumerate}[(i)]
 		\item $\seval{p}{\sgm}{\a_c}{\sgm'}$ (by $\MP$)
 		\item $\ValRep{v}{\tau}{\sgm'(\st)}$ (by $\MV$)
 		\item $\sgm' \ConEq{s_0} \sgm $
 		\item $\sids{\st} \SetLe \s_1$
 		\item $\s_0 \le \s_1$
 	\end{enumerate}
\end{lem}


\begin{thm}
	\label{main-correctness}
	\textbf{If} 
	\begin{enumerate}[(i)]
		\item $\Type{\Gam}{e}{\tau}$ (by some derivation $\MT$)
		\item $\Eval{\rho}{e}{v}$ (by $\ME$) 
		\item $\Trans{\del}{e}{\s_0}{\s_1}{\sfun{p}{\st}}$ (by $\MC$)
		\item $\forall x \in dom(\Gam). \Type{}{\rho(x)}{\Gam(x) } \wedge \sids{\del(x)} \SetLe \s_0  \wedge  \ValRep{\rho(x)}{\Gam(x)}{\sgm(\del(x))}$ \\
	\textbf{then} 
		\item $\seval{p}{\sgm}{\singl{()}}{\sgm'}$ (by $\MP$)
		\item  $\ValRep{v}{\tau}{\sgm'(\st)}$ (by $\MV$)
		\item $\sgm' \ConEq{s_0} \sgm $
		\item  $\sids{\st} \SetLe \s_1$
		\item $\s_0 \le \s_1$
	\end{enumerate} 
\end{thm}

\begin{proof}
	By induction on the syntax of $e$.
	
	\begin{itemize}
		\item Case $e = \Comp{e_1}{x}{y}{\cdot}$. \\
		
		We first must have: 
		\begin{enumerate}[(i)]
		\item 
		\PT{
			\UCN{\MT_1}{\Type{[x \|-> {\tau_1}]}{e_1}{\tau_2}}
			\LeLa{\MT = }
			\RiLa{(\Gam(y)=\tseq{\tau_1})}
			\UC{\Type{\Gam}{\Comp{e_1}{x}{y}{\cdot}}{\tseq{\tau_2}}}
		}
		
		\item
		\PT{
			\UCN{\ME_i}{(\Eval{[x \|-> {v_i}]}{e_1}{v_i'})^k_{i=1}}
			\LeLa{\ME = }
			\RiLa{(\rho(y)=\Seqk{v})}
			\UC{\Eval{\rho}{\Comp{e_1}{x}{y}{\cdot}}{\Seqk{v'}}}
		} 
		
		\item 
		\PT{
			\UCN{\MC_1}{\Trans{[x \|-> {\st_1}]}{e_1}{\s_0+1}{\s_1}{\sfun{p_1}{\st_2}}}
			\LeLa{\MC = }
			\RiLa{(\del(y)=(\st_1,\s_2))}
			\UC{\Trans{\del}{\Comp{e_1}{x}{y}{\cdot}}{\s_0}{\s_1}{\sfun{\sdef{\s_0}{\usum(\s_2)}; \withctrl{\s_0}{p_1}{\st_2}}{(\st_2,\s_2)}}}
		}
	
	 So $p= (\sdef{\s_0}{\usum(\s_2)}; \withctrl{\s_0}{p_1}{\st_2}),
	\tau = \tseq{\tau_2}, v = \Seqk{v'}, \st = (\st_2,\s_2). $ \\

	\item $\Type{}{\rho(y)}{\Gam(y)}$ gives us $\Type{}{\Seqk{v}}{\tseq{\tau_1}}$, which must have the derivation:
	\begin{equation}\label{type-vi}	
	\PT{
		\AC{(\Type{}{v_i}{\tau_1})^k_{i=1}}
		\UC{\Type{}{\Seqk{v}}{\tseq{\tau_1}}}}
	\end{equation}
	
	$\sids{\del(y)} \.< \s_0$ gives us
	\begin{equation} \label{sids-st1-s2}
	    \sids{\del(y)} = \sids{(\st_1,\s_2)} 
	    = \sids{\st_1} \cup \{s_2\} \.< \s_0
 	\end{equation}
	
	$\ValRep{\rho(y)}{\Gam(y)}{\sgm(\del(y))} =
 	 \ValRep{\Seqk{v}}{\tseq{\tau_1}}{\sgm((\st_1,\s_2))}$ 
 	 must have the derivation: 
 	 \eq{valrep0}{
 	 \PT{
		\UCN{\MV_i}{(\ValRep{v_i}{\tau_1}{\v_i})^k_{i=1}}
		\UC{\ValRep{\Seqk{v}}{\tseq{\tau_1}}{\sgm((\st_1,\s_2))}}
	 }}
    where 
    \eq{sgm-st1}
    {\sgm(\st_1) = w =  w_1 \ {\++} \ w_2 \ {\++} ... {\++} \ w_k}

    and \eq{sgm-s2}
    {\sgm(\s_2) = \< \F_1,..., \F_k, \T \'>}
	

    Now we shall show: 
	\item \label{proof-eval}
	$\seval{\sdef{\s_0}{\usum(\s_2)}; \withctrl{\s_0}{p_1}{\st_2}}{\sgm}{\singl{()}}{\sgm'}$
	
	%TODO proof of MP0
	\textbf{?? proof of MP0}
	
	Assume we have 
	$\MP_0$ of $ \seval{\sdef{\s_0}{\usum(\s_2)}}{\sgm}{\singl{()}}{\sgm[\s_0 \|-> \vrange{()_1}{()_k}]}$
	
	Then $\MP$ must have the shape:
	
	$$ \PT{
		\UCN{\MP_0}{\seval{\sdef{\s_0}{\usum(\s_2)}}{\sgm}{\singl{()}}{\sgm[\s_0 \|-> \vrange{()_1}{()_k}]}}
		\UCN{\MP_1}{\seval{\withctrl{\s_0}{p_1}{\st_2}}{\sgm[\s_0 \|-> \vrange{()_1}{()_k}]}{\<()\'>}{\sgm'}}
		\BC{\seval{\sdef{\s_0}{\usum(\s_2)}; \withctrl{\s_0}{p_1}{\st_2}}{\sgm}{\singl{()}}{\sgm'}}
	} $$
	
	There are two possibilities for $\MP_1$: 
	\begin{enumerate}
	
		\item \label{subcase-1}
		Subcase $k=0$, that is $\sgm[\s_0 \|-> \vrange{()_1}{()_k}](\s_0) = \emptyv$.\\
		So 
	$$\PT{
		\AC{}
		\RiLa{(\sids{\st_2} = \{\s'_1,...,\s'_i\})}
		\LeLa{\MP_1 = }
		\UC{\seval{\withctrl{\s_0}{p_1}{\st_2}}{\sgm}{\< () \'>}
			{\sgm[\s_0 \|-> \emptyv, \s_1' \|-> \emptyv, ..., \s_i' \|-> \emptyv]}}
	  },$$ 
    thus $\sgm' = \sgm[\s_0 \|-> \emptyv, \s_1' \|-> \emptyv, ..., \s_i' \|-> \emptyv]$. 
	
	\item \label{subcase-2}
	Subcase $k > 0$, that is $\sgm[\s_0 \|-> \vrange{()_1}{()_k}] = \< ()|\a \'> .$ \\
	Then 
	$$\PT{
		\AC{\seval{p_1}{\sgm[\s_0 \|-> \vrange{()_1}{()_k}]}{\vrange{()_1}{()_k}}{\sgm''}}
		\LeLa{\MP_1 = }
		\UC{\seval{\withctrl {s_0} {p_1} {\st_2} } 
				  {\sgm[\s_0 \|->   \vrange{()_1}{()_k}]} 
				  {\< () \'>} 
				  {\sgm[\s_0 \|-> \<()_1,...,()_k \'>]}}
	}$$ in which $\sgm[\s_0 \|-> \<()_1,...,()_k \'>](\st_2) = \sgm''(\st_2).$

	\end{enumerate}

	
	\item \label{proof-valre}
	$\ValRep{\Seqk{v'}}{\tseq{\tau_2}}{\sgm'((\st_2,\s_2))}$ by $\MV$. \\
    We still have two subcases based on the two in the proof of (\ref{proof-eval}) respectively.
    
	\begin{itemize}
		\item Subcase continuing (\ref{subcase-1}) \\
		Since $k=0$, then $v = \{ \}$, $\sgm(\s_2) = \oT$ (from \eqref{sids-st1-s2}), and \\
		$\sgm'(\s_2) = \sgm[\s_0 \|-> \emptyv, \s_1' \|-> \emptyv, ..., \s_i' \|-> \emptyv](\s_2) = \sgm(\s_2) = \oT$, \\
		$\sgm'(\st_2) = \sgm[\s_0 \|-> \emptyv, \s_1' \|-> \emptyv, ..., \s_i' \|-> \emptyv](\st_2) = (...((\emptyv,\emptyv)_1,\emptyv)_2,...)_{i-1}.$ \\
	
		Therefore $\sgm'((\st_2,\s_2)) = (\sgm'(\st_2), \sgm'(\s_2))$ and we construct 
		$$\MV = 
		 \PT{\Axiom{\ValRep{\{\}}{\tseq{\tau_2}}{((...(\emptyv,\emptyv)_1,...)_{i-1},\oT)}}}$$ as required.
		
		\item Subcase continuing (\ref{subcase-2}) \\
		Since we have 
		$$\MT_1 = \PT{\AC{\Type{[x \|-> {\tau_1}]}{e_1}{\tau_2}}}$$
		$$\ME_i = \PT{\AC{\Eval{[x \|-> {v_i}]}{e_1}{v_i',}}}$$
		$$\MP_1 = \PT{\AC{\Trans{[x \|-> {\st_1}]}{e_1}{\s_0+1}{\s_1}{\sfun{p_1}{\st_2}}}}$$
		
		Let $\Gam_1 = [x \|-> \tau_1], \rho_i= [x \|-> v_i]$ and $\del_1 = [x \|-> \st_1]$. \\
		From \eqref{type-vi} and \eqref{sids-st1-s2} it is clear that 
		$$\forall z \in dom(\Gam_1). \Type{}{\rho_i(z)}{\Gam_1(z)} \wedge 
		\sids{\del_1(z)} \.< \s_0 .$$
		
		We take $\sgm_i \~{\st_1} \sgm[\s_0 \|-> \<()_1,...,()_k \'>]$ 
		such that $\sgm_i(\st_1)= w_i$. \\
		From $\MV_i$ in \eqref{valrep0} we know that  
		$$\forall z \in dom(\Gam_1). \ValRep{\rho_i(z)}{\Gam_1(z)}{\sgm_i(\del_1(z))}.$$
	
		
		Then let $i$ range from $1$ to $k$: by IH on $\MT_1$ with $\ME_i$, $\MP_1$ we obtain the following result:
		\eq{isgm}{(\seval{p_1}{\sgm_i}{\<()\'>}{\sgm_i'})^k_{i=1}}
		\eq{vsgm}{(\ValRep{v'_i}{\tau_2}{\sgm_i'(\st_2)})^k_{i=1}}
		\eq{}{(\sgm_i' \ConEq{\s_0 +1} \sgm_i)^k_{i=1}}
		\eq{}{\sids{\st_2} {\.<} \s_1}
		\eq{}{\s_0+1 \le \s_1}
		
	    Using Lemma \ref{lem-sgm-join} (k-1) times on \eqref{isgm} gives us
	    $$\seval{p_1}{\sgm_1 \x{\st_1} ... \x{\st_1} \sgm_k}{\<()_1,...,()_k \'>}{\sgm_1' \x{\st_2} ... \x{\st_2} \sgm'_k}$$
	    
	    %TODO add property lemma
	    By Lemma \ref{lem-join-property} 
	    $${\sgm_1 \x{\st_1} ... \x{\st_1} \sgm_k} = \sgm[\s_0 \|-> \<()_1,...,()_k \'>]$$
	    and
	    $$\sgm_1' \x{\st_2} ... \x{\st_2} \sgm'_k = \sgm''$$ 
	    in which $\sgm''(\st_2) = \sgm'(\st_2) {\++} ... {\++} \sgm'(\st_2).$\\
		Let $\sgm'_i(\st_2) = w'_i$ and  $\sgm''(\st_2) = w'$, then
		$w' = w'_1 {\++} ... {\++} w'_k$. \\
		
	    Since $\sgm'(\st_2) = \sgm''(\st_2) = w$, and $\sgm'(\s_2) = \sgm(\s_2) = \< \F_1,...,\F_k,\T \'>,$
	    therefore $\sgm'((\st_2,\s_2)) = (\sgm'(\st_2),\sgm'(\s_2)) = (w,\< \F_1,...,\F_k,\T \'>)$, and now we can construct
	    $$\MV = 
	    \PT{
	    	\AC{(\ValRep{v'_i}{\tau_2}{w'_i})^k_{i=1}}
	    	\UC{\ValRep{\Seqk{v'}}{\tseq{\tau_2}}{(w',\< \F_1,..., \F_k, \T \'>)}}
	    }$$ as required.
		
	\end{itemize}
	
	\item $\sgm' \ConEq{\s_0} \sgm$
	\item $\sids{(\st_2,\s_2)} {\.<} \s_1$ 
	\item $\s_0 \le \s_1$ 
	
	\end{enumerate}
 
 \item Case $e = x$.
 \item Case $e = \Let{x}{e_1}{e_2}$
 \item Case $e = \hcall\Tupk{x}$	
	\end{itemize}	
\end{proof}

