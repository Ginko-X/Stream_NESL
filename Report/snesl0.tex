\def\s{\mathit{s}}  
\def\st{\mathit{st}} 
\def\SId{\mathbf{SId}}
\def\STree{\mathbf{STree}}

\def\<{\langle} 
\def\'>{\rangle}

\def\->{\rightarrow}
\def\=>{\Rightarrow}
\def\prefix {\sqsubseteq}


\def\v{w}
\def\a{\vec a}
\def\b{\vec b}
\def\c{\vec c}

\def\unit{()}
\def\vunit{\langle \unit \rangle}  

\def\vrange#1#2{\langle #1,...,#2 \rangle}
\def\lrange#1#2{\left[ #1,...,#2 \right]}

\def\emptyv{\langle \rangle}

\def\SvVal{\mathbf{SvVal}}

%\def\ctrl{\mathtt{Ctrl}}
\def\consta#1{\mathtt{Const_{#1}}} 
\def\toflag{\mathtt{ToFlags}}
\def\usum{\mathtt{Usum}}
\def\maptwo#1{\mathtt{MapTwo}_{#1}}
\def\scan{\mathtt{ScanPlus}}

\def\constaf#1{\mathtt{Const_{#1}()}} 
\def\toflagf#1{\mathtt{ToFlags}(#1)}
\def\usumf#1{\mathtt{Usum}(#1)}
\def\maptwof#1#2#3{\mathtt{MapTwo}_{#1}(#2,#3)}
\def\scanf#1#2{\mathtt{ScanPlus}(#1,#2)}

\def\:={:=}
\def\sdef#1#2{#1 := #2}
\def\withctrl#1#2#3#4{#4 := \mathtt{WithCtrl}(#1,#3,#2)}

\def\T{\mathtt{T}} 
\def\F{\mathtt{F}} 
\def\oT{\singl{\T}}
\def\oF{\singl{\F}}

\def\sids#1{\mathtt{sids}(#1)}

\def\++{+\!+}
\def\vapp#1#2{#1 {\++} #2}


\def\~#1{\stackrel{#1}{\sim}}
\def\x#1{\stackrel{#1}{\bowtie}} % sgm append



\def\lcall{\psi} 
\def\seval#1#2#3#4{\langle #1,#2 \rangle \Eva^{#3} #4} 
\def\sevalf#1#2#3#4{{\lcall}(#1,...,#2) \Eva^{#3} #4}

\def\sevalfg#1#2#3#4{#1(#2) \Eva^{#3} #4}


\def\block#1#2#3{{\lcall}(#1,...,#2) \Downarrow #3}  
\def\blockf#1#2#3{#1(#2) \da #3} 

\def\da{\Downarrow}
\def\dda{\downdownarrows}
\def\unary#1#2#3{{\lcall}(#1,...,#2) \dda #3}

\def\blockv#1#2#3#4{\lcall_{#1}(#2,...,#3) \Downarrow #4}  
\def\unaryv#1#2#3#4#5{\lcall_{#1}(#2,...,#3) \dda^{#4} #5}



\def\singl#1{\langle #1 \rangle}
\def\|->{\mapsto}   % map 
\def\>->{\rightarrowtail} % map a bunch of variables
\def\=>#1#2{\Rightarrow^{#1}_{#2}}


%translation
\def\sfun#1#2{(#1,#2)}

% compiling/translation
\def\Trans#1#2#3#4#5{#1 \Env #2 \=>{#3}{#4} #5}
\def\Transf#1#2#3#4#5{#1(#2) \=>{#3}{#4} #5}
 
 
\def\S{\mathbf{S}}
\def\Sin{\mathbf{S}_{in}}
\def\Sout{\mathbf{S}_{out}}
\def\FV#1{\mathtt{fv}(#1)}
\def\dv#1{\mathtt{dv}(#1)}

\numberwithin{equation}{section}

\newcommand{\eq}[2]{\begin{equation}\label{#1} #2\end{equation}}

\providecommand{\versionnumber}{0.0.7}


\section{Level-0}

Draft version \versionnumber: 
\begin{itemize}
	\item changed WithCtrl: added import and export list 
	\item adjusted section structure
    \item small changes of some function notations
	\item Note: the symbols/functions used in the main correctness theroem have
    not been updated yet
\end{itemize}

\section{Source Language}

\subsection{Source language syntax}
SNESL Expressions:
$$e ::= x \ | \ \Let{x}{e_1}{e_2} \ | \ \hcall{\Tupk{x}} \ | \ \Comp{e}{x}{y}{\cdot} $$
$$\hcall = \*{const}_n \ | \ \*{iota} \ | \ \*{plus} $$ 

Values: \\
$$ n \in \*{Z} $$
$$ v::= n \ | \ \Seqk{v}$$

\subsection{Type system}
$$\tau ::= \int | \tseq{\tau_1}$$

Type environment $\Gamma = [x_1 \|-> \tau_1, ..., x_i \|-> {\tau_i} ]$.
\begin{itemize}

\item Expression typing rules:\\

 \Jug{\Type{\Gam}{e}{\tau}}

\PT{
	\AxiomC{}
	\RiLa{(\Gam(x) = \tau)}
    \UC{\Type{\Gam}{x}{\tau}}
}
\PT{
	\AC{\Type{\Gam}{e_1}{\tau_1}}
	\AC{\Type{\Gam[x \|-> \tau_1]}{e_2}{\tau}}
	\BC{\Type{\Gam}{\Let{x}{e_1}{e_2}}{\tau}}
}\\[1ex]


\PT{
	\AC{\Typef {\hcall} {\replc{k}{\tau}} {\tau}}
	\RiLa{((\Gam(x_i)= \tau_i)^k_{i=1})}
	\UC{\Type{\Gam}{\hcall{\Tupk{x}}}{\tau}}
}
\PT{
	\AC{\Type{[x \|-> {\tau_1}]}{e}{\tau}}
	\RiLa{(\Gam(y)=\tseq{\tau_1})}
	\UC{\Type{\Gam}{\Comp{e}{x}{y}{\cdot}}{\tseq{\tau}}}
}\\[2ex]


\item Auxiliary \Jug{\Typef {\hcall} {\replc{k}{\tau}} {\tau}}

\PT{\Axiom{\Typef{\constn{n}}{}{\int}}}
\PT{\Axiom{\Typef{\iotan}{\int} {\tseq{\int}}}}
\PT{\Axiom{\Typef{\plusn}{\int,\int} {\int}}}

% value types
\item Value typing rules: \\

\Jug{\TypeV{v}{\tau}}

\PT{\Axiom{\TypeV{n}{\int}}}
\PT{
	\AC{(\TypeV{v_i}{\tau})^k_{i=1}}
	\UC{\TypeV{\Seqk{v}}{\tseq{\tau}}}
}

\end{itemize}

\subsection{Source language semantics}
$ \rho = [x_1 \|-> v_1,...,x_i \|-> v_i]$ \\
\begin{itemize}
\item \Jug{\Eval{\rho}{e}{v}}
\PT{
	\AxiomC{}
	\RiLa{(\rho(x)=v)}
	\UC{\Eval{\rho}{x}{v}}
}
\PT{
	\AC{\Eval{\rho}{e_1}{v_1}}
	\AC{\Eval{\rho[x \|-> v_1]}{e_2}{v}}
	\BC{\Eval{\rho}{\Let{e_1}{x}{e_2}}{v}}	
}\\[1ex]

\PT{
	\AC{\EvalF\hcall{\replc{k}{v}}{v}}
	\RiLa{((\rho(x_i)=v_i)^k_{i=1})}
	\UC{\Eval{\rho}{\hcall{\Tupk{x}}}{v}}
}\\[1ex]

\PT{
	\AC{(\Eval{[x \|-> {v_i}]}{e}{v_i'})^k_{i=1}}
	\RiLa{(\rho(y)=\Seqk{v})}
	\UC{\Eval{\rho}{\Comp{e}{x}{y}{\cdot}}{\Seqk{v'}}}
}\\[1ex]

\item Auxiliary \Jug{\EvalF\hcall{\replc{k}{v}}{v}}

\PT{\Axiom{\EvalF{\constn{n}}{}{n}}}
\PT{\AC{}
	\RiLa{(n \ge 0)}
	\UC{\EvalF{\iotan}{n}{\{0,1,...,n-1\}}}} \\[1ex]

\PT{\AC{} 
	\RiLa{(n_3= n_1+n_2)} 
	\UC{\EvalF{\plusn}{n_1,n_2}{n_3}}}

\end{itemize}

\section{Target language}

\subsection{SVCODE syntax}
\begin{enumerate}[(1)]
\item Stream id: $$\s \in \SId = \*{N} = \{0,1,2...\}$$

A list of $\SId$: 
$$\S = [\s_1,..., \s_i] $$

Note: for simplicity, in some cases where duplicate of some elements does not affect the correctness
we will also use $\S$ to stand for a set of $\SId$s which keeps only one copy of each element in $\S$.

\item SVCODE operations: $$\psi ::= \consta{a} \ | \ \toflag
\ | \ \usum \ | \ \maptwo{\oplus} \ | \ \scan_{n_0} $$
where $\oplus$ stands for some binary operation on $\int$. \\


\item SVCODE program: 
\begin{align*}
	p :: & = \ \epsilon \\ 
         &\ \ | \ \sdef{\s}{\psi(s_1,...,s_i)}; p_1  \\
         &\ \ | \ \withctrl{\s}{p_1}{\Sin}{\Sout}; p_2   \tag{$\Sin  = \{s\} \cup \FV{p_1}, \Sout \subseteq \dv{p_1} $ }\\
\end{align*}
Note: here this $\Sin$ is actually slightly different from the import list used in our streaming interpreter which does not contain the new control stream id. 
So it may cause some confusion later when we introduce the streaming language.
We may want to remove this $\Sin$ from WithCtrl instruction if it turns out it is not necessary to make it an explicit component here.

\item Differentce of sets: \\
For two sets $A$ and $B$, 
\[ A -B = \{s | s \in A \wedge s \notin B\} \]

It is easy to prove the following properties: 
 \begin{itemize}
 	\item For any three sets $A,B$ and $C$: 
 			\eq{set-p1}{(A - B) \cap C = (A \cap C) - B  =  A \cap (C - B)}
 	\item For two sets $A$ and $B$,
 	       \eq {set-p2}{A \cap B = \emptyset  \Leftrightarrow A - B = A}
 	
 \end{itemize}

\item Free variables: a set (or list) of stream ids that are not defined but referred to by a SVCODE program
\begin{align*}
	&\FV{\epsilon} \ = \{\}\\
	&\FV{\sdef{\s}{\psi(s_1,...,s_i)};p_1} = \{s_1,...,s_i\} \cup \FV{p_1} - \{\s\}\\
	&\FV{\withctrl{\s_c}{p_1}{\Sin}{\Sout};p_2}  = \Sin \cup \FV{p_2} - \Sout
\end{align*}




\item Defined variables: a set (or list) of stream ids that are defined by a SVCODE progrom and accessible to the outside environment of the program
\begin{align*}
	&\dv{\epsilon} \ = \{\}\\
	&\dv{\sdef{\s}{\psi(s_1,...,s_i)};p_1} = \{s\} \cup \dv{p_1}\\
	&\dv{\withctrl{\s_c}{p_1}{\Sin}{\Sout};p_2}  = \Sout \cup \dv{p_2}
\end{align*}


\item SVCODE streams: 
$$b \in \{\T,\F \}$$
$$ a ::= n \ | \ b \ | \ \unit$$
$$\b = \vrange{b_1}{b_i}$$ 
$$\a = \vrange{a_1}{a_i}  $$

\item



\item Notations and operations about streams:
\begin{itemize}
	\item For some $a_0$ and $\a = \< a_1,...,a_i \'>$, let $\< a_0 | \a \'>  = \< a_0,a_1,...,a_i \'>. $ 

	\item $\vapp{\vrange{a_1}{a_i}} {\vrange{a_1'}{a_j'}} = \langle a_1,...,a_i,a_1',...,a_j' \rangle $ \\

%    \item 
%    For some set of $\SId$, $t$, and some $\s \in \SId$, let $t \.< \s$ denote $\forall \s' \in t. \s' < \s$.

\end{itemize}

\end{enumerate}

\subsection{SVCODE semantics}

SVCODE stores $\sgm = [\s_1 \|-> {\a_1},...,\s_i \|-> {\a_i}]$.\\



\begin{itemize}

\item \Jug{\seval{p}{\sgm}{\c}{\sgm'}}
$\c$ is the control stream.\\

\PRule{Empty}{ \infer{\seval{\epsilon}{\sgm}{\c}{\sgm}}{} }

\PRule{Xducer}{\PT{\AC{\sevalf{\a_1}{\a_k}{\c}{\a}}
		\AC{\seval{p_1}{\sgm[\s \|-> \a]}{\c}{\sgm'}}
	\RiLa{((\sgm(\s_i) = \a_i)^k_{i=1})}
	\BC{\seval{\sdef{\s}{\lcall\Tupk\s};p_1}{\sgm}{\c}{\sgm'}}
}} \\[2ex]

\PRule{Wc-Emp}{\PT{
	\AC{\seval{p_2}{\sgm[\s_1 \|-> \emptyv, ..., \s_i \|-> \emptyv]}{\c}{\sgm'}}
	\RiLa{
		\left(
			\begin{aligned}
				&\forall s \in \Sin. \sgm(s) = \emptyv \\
				&\Sout = [s_1,...,s_i]
			\end{aligned}
		\right)}
	\UC{\seval{\withctrl{\s_c}{p_1}{\Sin}{\Sout};p_2}{\sgm}{\c}{\sgm'}}
}}\\[2ex]

\makebox[1.0\textwidth][c] {\PRule{Wc-Nonemp}{\PT{
	\AC{\seval{p_1}{\sgm}{\c_1}{\sgm''}}
	\AC{\seval{p_2}{\sgm[\s_1 \|-> \sgm''(\s_1),...,\s_i \|-> \sgm''(\s_i)]}{\c}{\sgm'}}
	\RiLa{\left(
		\begin{aligned} 
		&\sgm(\s_c)= \c_1 = \< () | ...\'> \\
	    &\Sout = [s_1,...,s_i]
		\end{aligned}\right)}
	\BC{\seval{\withctrl{\s_c}{p_1}{\Sin}{\Sout};p_2}{\sgm}{\c}{\sgm'}}
}}}\\[2ex]

\PRule{Seq}{\PT{
	\AC{\seval{p_1}{\sgm}{\c}{\sgm''}}
    \AC{\seval{p_2}{\sgm''}{\c}{\sgm'}}	
    \BC{\seval{p_1;p_2}{\sgm}{\c}{\sgm'}}
}}


\item $Transducer$ semantics: \\

\Jug{\sevalf{\a_1}{\a_k}{\c}{\a}} 


\PRule{X-Loop}{\PT{
	\AC{\block{\a_{11}}{\a_{k1}}{\a_1}}
	\AC{\sevalf{\a_{12}}{\a_{k2}}{\c}{\a_2}}
	\RiLa{(\a = \vapp{\a_1}{\a_2})}
	\BC{\sevalf{\vapp{\a_{11}}{\a_{12}}}{\vapp{\a_{k1}}{\a_{k2}}}{\< a_0 | \c \'>}{\a}}
}}\\[2ex]


\PRule{X-Termi}{\infer{\sevalf {\emptyv_1} {\emptyv_k} \emptyv \emptyv}{}}
\footnote{For convenience, in this thesis we add subscripts to a sequence of constants, such as $\emptyv, \F, 1$, to denote the total number of these constants.}

\item Transducer $block$ semantics: \\ 

\Jug{\block{\a_1}{\a_k}{\a}}

\PRule{Const}{\PT{\Axiom{\constaf{a} \da \singl{a}}}}
\PRule{ToFlags}{\PT{\Axiom{\toflag(\singl{n}) \da \langle \F_1,...,\F_n,\T \rangle}}} \\

\PRule{MapTwo}{\PT{\AC{}
	\RiLa{(n_3= n_1 \oplus n_2)}
	\UC{\maptwo{\oplus}(\singl{n_1}, \singl{n_2}) \da \singl{n_3}}
}} \\

%--- UsumF
\PRule{UsumF}{
	\PT{\AC{\blockf{\usum}{\b}{\a}}
		\UC{\blockf{\usum}{ \<\F|\b \'>}{\<()|\a\'>}}
	}
}
\PRule{UsumT}{
	\PT{\Axiom{\blockf{\usum}{\oT}{\emptyv}}}
}\\

\PRule{ScanF}{
	\PT{\AC{\blockf{\scan_{n_0+n}}{\b,\a}{\a'}}
		\UC{\blockf{\scan_{n_0}}{\<\F|\b \'>, \<n|\a\'>}{\<n_0|\a'\'>}}
	}		
}
\PRule{ScanT}{
	\PT{\Axiom{\blockf{\scan_{n_0}}{\oT, \emptyv}{\emptyv}}}	
}
\\


Or if we want to use $unary$ semantics maybe for later: \\
\begin{mdframed}
\PT{
	\AC{\unary{\singl \F}{\a_{k1}}{\a_1}}
	\AC{\block{\a_{12}}{\a_{k2}}{\a_2}}
	\RiLa{(\a = \vapp{\a_1}{\a_2})}
	\BC{\block{\vapp {\singl\F} {\a_{12}}} {\vapp {\a_{k1}} {\a_{k2}}}{\a}}
}\\[2ex]

\PT{
	\AC{\unary{\oT} {\a_k}{\a}}
	\UC{\block{\oT}{\a_k} \a}
}\\[2ex]

\begin{itemize}
\item Transducer $unary$ semantics:\\ 

\Jug{\unary{\singl b}{\a_k}{\a}}

\PT{ \Axiom{\usum(\oF) \dda \vunit}}
\PT{\Axiom{\usum(\oT) \dda \emptyv }} \\[1ex]


%loopuv
\item Transducer block with $accumulator$: \\

\Jug{\blockv{n}{\a_1}{\a_k}{\a}}
\PT{
	\AC{\unaryv{n_0} {\singl \F}{\a_{k1}}{n_0'} {\singl{n_1}}  }
	\AC{\blockv{n_0'}{\a_{12}}{\a_{k2}}{\a_2}}
	\BC{\blockv{n_0} {\vapp {\singl\F} {\a_{12}}} {\vapp {\a_{k1}} {\a_{k2}}}{\vapp {\singl{n_1}} {\a_2}} }
}\\[2ex]

\PT{
	\AC{\unaryv {n_0} \oT {\a_k} {} {\a}}
	\UC{\blockv {n_0} \oT {\a_k} {\a} }
}

\item Transducer unary with $accumulator$: \\

\Jug{\unaryv{n}{\oF}{\a_k}{n'}{\a}}

\PT{\Axiom{\scan_{n_0}(\oF,{\singl{n}}) \dda^{n_0+n} {\singl{n_0}} }} \\

\Jug{\unaryv{n}{\oT}{\a_k}{}{\a}}

\PT{\Axiom{\scan_{n_0}(\oT, \emptyv) \dda {\emptyv} }}
\end{itemize}
\end{mdframed}


\end{itemize}





\subsection{Definitions}
We first define a binary relation $\~\S$ on stores to denote that two stores are $similar$: they have identical domains, and their bound values by $\S$ are the same. 
We call this $\S$ an $overlap$ of these two stores.

\begin{defi}[\textbf{Stores similarity}]
	\label{def-sgm-sim}
	
	$\sgm_1 {\~{\S}} \sgm_2 $
	iff \\
	(1) $dom(\sgm_1) = dom(\sgm_2)$ \\
	(2) $\forall s \in \S.\sgm_1(s)= \sgm_2(s)$ \\
\end{defi}

According to this definition, it is only meaningful to have $\S  \subseteq dom(\sgm_1)$ (= $dom(\sgm_2)$).  
When $\S = dom(\sgm_1) = dom(\sgm_2)$, $\sgm_1$ and $\sgm_2$ are identical. 
It is easy to show that this relation $\overset{\S}{\sim}$ is transitive.
\begin{itemize}
	\item If $\sgm_1 \~\S \sgm_2$ and $\sgm_2 \~\S \sgm_3$, then $\sgm_1 \~\S \sgm_3$.
	
\end{itemize}


We define another binary operation $\x\S$ on stores to denote a kind of specical concatenation of two similar stores: 
the $concatenation$ of two similar stores is a new store, in which the bound values by $\S$ are from any of the parameter stores, and 
the others are the concatenation of the values from the two stores. 
In other words, a $concatenation$ of two similar stores is only a concatenation of the bound values that $maybe$ different in these stores.
\begin{defi}[\textbf{Store Concatenation}]
	\label{def-sgm-join}
	$\sgm_1 \x{\S} \sgm_2 = \sgm$ iff \\
	(1) $\sgm_1 \~{\S} \sgm_2$  \\
	(2) $\sgm(s) =
	\begin{cases}
	\sgm_i(s),& s \in \S, i \in \{1,2\}\\
	\sgm_1(\s) {\++} \sgm_2(s), & otherwise \\
	\end{cases} $
\end{defi}

\begin{lem} \label{lem-join1}
	If $\sgm_1 \x{\S} \sgm_2 = \sgm$, 
	then $\sgm_1 \~{\S} \sgm$ and $\sgm_2 \~{\S} \sgm.$
\end{lem}
This lemma says that the concatenation result of two similar stores is still similar to each of them.
%\begin{proof}
%	According to Definition \ref{def-sgm-join}, it is clear that $dom(\sgm) = dom(\sgm_1)$, and $\forall s \in \S. \sgm(s) = \sgm_1(s)$. Then by Definiton \ref{def-sgm-sim}, $\sgm \~\S \sgm_1$
%\end{proof}


\begin{lem} \label{lem-psi-join}
	If $\sevalfg{\lcall}{\a_{11},...,\a_{1k}}{\c_1}{\a_1}$,
	and $\sevalfg{\lcall}{\a_{21},...,\a_{2k}}{\c_2}{\a_2}$,
	then $\sevalfg{\lcall}{\a_{11} {\++} \a_{21},...,\a_{1k} {\++} \a_{2k}}{\c_1 {\++} \c_2}{\a_1 {\++} \a_2}$.
\end{lem}


\begin{lem} \label{lem-emp-join}
	If 
	\begin{enumerate} [(i)]
		\item $\sgm_1 \~{S} \sgm_2$
		\item $\seval{p}{\sgm_1}{\c}{\sgm}$
		\item $\FV{p} \cap \S = \emptyset$
		\item $\forall s \in \FV{p}. \sgm_2(s) = \emptyv$
	\end{enumerate}
	then 
	\begin{enumerate}[(i)]
		\setcounter{enumi}{4}
		\item $\seval{p}{\sgm_1 \x{\S} \sgm_2}{\c}{\sgm'}$
		\item $\forall s' \in \dv{p}. \sgm(s') = \sgm'(s')$
	\end{enumerate}
\end{lem}

\begin{lem} [\textbf{Stores concatenation lemma}] \label{lem-sgm-join}
	If 
	\begin{enumerate}[(i)]
		\item $\sgm_1 \~{\S} \sgm_2$
		\item $\seval{p}{\sgm_1}{\c_1}{\sgm_1'}$ (by some derivation $\MP_1$)
		\item $	\seval{p}{\sgm_2} {\c_2} {\sgm_2'}$ (by some derivation $\MP_2$)
		\item $\FV{p} \cap \S = \emptyset $
	\end{enumerate}
	then $\seval{p}{\sgm_1 \x\S \sgm_2}{\c_1 {\++} \c_2}{ \sgm_1' \x\S \sgm_2' }$ (by $\MP$).
\end{lem}

We need this lemma to prove that the results of single computations inside a comprehension body (i.e. $p$ in the lemma) can be concatenated to express a parallel computation. From the other direction, we can consider this process as distributing or splitting the compuation $p$ on even smaller degree of parallel computations, in which all the supplier streams, i.e., $\FV{p}$, are splitted to
feed the transducers. The splitted parallel degrees are specified by the
control streams, i.e., $\c_1$ and $\c_2$ in the lemma. Other untouched $\SId$s in all $\sgm$s (i.e., $\S$) have no change throughout the process.\\

\begin{proof}
	By induction on the syntax of $p$.
\def\sgmx{\sgm_1 \x{\S} \sgm_2}
\def\sgmpx{\sgm_1' \x{\S} \sgm_2'}
\def\cc{\c_1 {\++} \c_2}

 
	\begin{itemize}
	\item Case $p = \epsilon$. \\
	$\MP_1$ must be $\overline{\seval{\epsilon}{\sgm_1}{\c_1}{\sgm_1}}$, and
	$\MP_2$ must be $\overline{\seval{\epsilon}{\sgm_2}{\c_2}{\sgm_2}}$. \\
	So $\sgm_1' = \sgm_1$, and $\sgm_2' = \sgm_2$, thus $\sgm_1' \x{\S} \sgm_2' = \sgm_1 \x{\S} \sgm_2$. \\
	
	By $\PName{Empty}$, we take $\MP$ = $\overline{\seval{\epsilon}{\sgmx}{\c_1 {\++} \c_2}{\sgmx}}$ and we are done. 
	
\item Case $p = \sdef{\s_l}{\lcall(s_1,...,s_i)}; p'.$ \\
\def\casetwo{\sdef{\s_l}{\lcall\Tupk\s};p'}	

	$\MP_1$ must look like 
	$$\PT{\UCN{\MP_{10}}{\sevalf{\a_1}{\a_k}{\c_1}{\a}}
		  \UCN{\MP_{11}}{\seval{p'}{\sgm_1[\s_l \|-> \a]}{\c_1}{\sgm_1'}}
			\BC{\seval{\sdef{\s_l}{\lcall\Tupk\s};p'}{\sgm_1}{\c_1}{\sgm_1'}}
	} $$

	and we have 
	    \eq{eq-lem24-c2-as1}{(\sgm_1(\s_i) = \a_i)^k_{i=1}}
	
	
    Similarly, $\MP_2$ must look like 
	$$\PT{\UCN{\MP_{20}}{\sevalf{\a_1'}{\a_k'}{\c_2}{\a'}}
		\UCN{\MP_{21}}{\seval{p'}{\sgm_2[\s_l \|-> \a']}{\c_2}{\sgm_2'}}
		\BC{\seval{\sdef{\s_l}{\lcall\Tupk\s};p'}{\sgm_2}{\c_2}{\sgm_2'}}
	} $$
	
	and we have
	\eq{eq-lem24-c2-as2}{(\sgm_2(\s_i) = \a_i')^k_{i=1}}
	
	From assumption $(iv)$ we have
	\begin{align*}
		\FV{\casetwo} \cap \S & = \emptyset \\
		(\{s_1,...,s_i\} \cup \FV{p'} - \{\s_l\}) \cap \S & = \emptyset \tag{by definition of $\FV{}$} \\
		(\{s_1,...,s_i\} \cup \FV{p'}) \cap (\S-\{\s_l\}) & = \emptyset \tag{by \ref{set-p1}} \\
		(\{s_1,...,s_i\} \cup \FV{p'}) \cap \S & = \emptyset \tag{by \ref{set-p2} with ??? $\S \cap \{\s_l\} = \emptyset$} \\
		(\{s_1,...,s_i\} \cap \S) \cup (\FV{p'}) \cap \S ) & = \emptyset 
	\end{align*}
    thus 
	\eq{eq-lem24-c2-as3}{\{s_1,...,s_i\} \cap \S = \emptyset}
	\eq{eq-lem24-c2-as4}{\FV{p'} \cap \S = \emptyset}
    
    By \ref{lem-psi-join} on $\MP_{10}$, $\MP_{20}$, we get a derivation $\MP'$ of 
    \[ \sevalfg{\lcall}{\a_1  {\++} \a_1',...,\a_k {\++} \a_k' } 
             {\c_1 {\++} \c_2} {\a {\++} \a'} \]
    
    Since $\sgm_1 \~{\S} \sgm_2$, by the definitons of store similarity and concatenation, it is easy to show that 
    \eq{eq-lem24-c2-7}{ \sgm_1[\s_l \|-> \a ] \~{\S} \sgm_2[\s_l \|-> \a']}
   
 \def\sgmxp{\sgm_1[\s_l \|-> \a ] \x{\S} \sgm_2[\s_l \|-> \a']}
    and 
    \eq{eq-lem24-c2-8}{\sgmxp = \sgmx[\s_l \|-> \a {\++} \a'] }
    

    
    Then by IH on \ref{eq-lem24-c2-7}, $\MP_{11}$, $\MP_{21}$, \ref{eq-lem24-c2-as4}, we obtain
    a derivation $\MP''$ of 
    \[\seval{p'}{\sgmxp}{\c_1 {\++} \c_2}{\sgm_1' \x{\S} \sgm_2'} \]
    
    By replacing the start store in $\MP''$ with  the right-hand side of \ref{eq-lem24-c2-8}, we get $\MP'''$ of 
    \[\seval{p'}{\sgmx[\s_l \|-> \a {\++} \a']}{\c_1 {\++} \c_2}{\sgm_1' \x{\S} \sgm_2'} \]
    
    Using the rule $\PName{Xducer}$, we can build $\MP$ as follows
   	$$\PT{\UCN{\MP'}{\sevalfg{\lcall}{\a_1  {\++} \a_1',...,\a_k {\++} \a_k' } 
   			{\c_1 {\++} \c_2} {\a {\++} \a'}}
    	\UCN{\MP'''}{\seval{p'}{\sgmx[\s_l \|-> \a {\++} \a']}{\c_1 {\++} \c_2}{\sgm_1' \x{\S} \sgm_2'}}
    	\BC{\seval{\casetwo}{\sgmx}{\c_1 {\++} \c_2}{\sgm_1' \x{\S} \sgm_2'}}
    } $$
    as required.


\item Case $p = \withctrl{\s_c}{p_0}{\Sin}{\Sout}; p'$ where  
 \eq{eq-lem24-c3-1}{\Sin  = \{s_c\} \cup \FV{p_0}} and
 \eq {eq-lem24-c3-2}{\Sout \subseteq \dv{p_0}}

\def\casethree{p = \withctrl{\s_c}{p_0}{\Sin}{\Sout}; p'}

	From the assumption ($iv$), we have 
	\begin{align*}
	\FV{\casethree} \cap \S & = \emptyset \\
	(\Sin \cup \FV{p'} - \Sout) \cap \S & = \emptyset \tag{by definition of $\FV{}$} \\
	(\Sin \cup \FV{p'}) \cap (\S-\Sout) & = \emptyset \tag{by \ref{set-p1}} \\
	(\Sin \cup \FV{p'}) \cap \S & = \emptyset \tag{by \ref{set-p2} with ??? $\S \cap \Sout = \emptyset$} \\
	(\Sin \cap \S) \cup (\FV{p'}) \cap \S ) & = \emptyset 
	\end{align*}
	thus 
	\eq{eq-lem24-c3-as3}{\Sin \cap \S = \emptyset}
	\eq{eq-lem24-c3-4}{\FV{p'} \cap \S = \emptyset}
	
    Since \ref{eq-lem24-c3-1} with \ref{eq-lem24-c3-as3}, we also have 
    	\eq{eq-lem24-c3-as5}{\{s_c\} \cap \S = \emptyset}
    	\eq{eq-lem24-c3-as6}{\FV{p_0} \cap \S = \emptyset}
    
    Assume $\Sout = [s_1,...,s_j]$. \\	
    There are four possibilities: 
   
    \begin{itemize}
\def\eqnumthree#1{eq-lem24-c3-{#1}}

    	\item Subcase both $\MP_1$ and $\MP_2$ use $\PName{Wc-Emp}$. \\
    	
    	So $\MP_1$ must look like 
    	
    	$$\PT{
    		\UCN{\MP_1'}{\seval{p'}{\sgm_1[\s_1 \|-> \emptyv, ..., \s_j \|-> \emptyv]}{\c_1}{\sgm_1'}}
    		\UC{\seval{\casethree}{\sgm_1}{\c_1}{\sgm_1'}}
    	}$$
    	and we have     	
    		\[\forall s \in \Sin. \sgm_1(s) = \emptyv \]
        that is, 
    		\eq{eq-lem24-c3-7}{\sgm_1(s_c) = \emptyv}
    	and 
    	  	\eq{\eqnumthree{8}}{\forall s \in \FV{p_0}. \sgm_1(s) = \emptyv}
    	
    	Similarly,$\MP_2$ must look like 
    	
    	$$\PT{
    		\UCN{\MP_2'}{\seval{p'}{\sgm_2[\s_1 \|-> \emptyv, ..., \s_j \|-> \emptyv]}{\c_2}{\sgm_2'}}
    		\UC{\seval{\casethree}{\sgm_2}{\c_2}{\sgm_2'}}
    	}$$
    	and we have     	
    	\[\forall s \in \Sin. \sgm_2(s) = \emptyv \]
    	that is, 
    	\eq{eq-lem24-c3-9}{\sgm_2(s_c) = \emptyv}
    	and 
    	\eq{\eqnumthree{10}}{\forall s \in \FV{p_0}. \sgm_2(s) = \emptyv}
 
 \def\sgmbe#1{\sgm_#1[\s_1 \|-> \emptyv, ..., \s_j \|-> \emptyv]}
 	  	
    	Since $\sgm_1 \~{\S} \sgm_2$, it is easy to show that
    	\eq{\eqnumthree{11}}
    		{\sgmbe{1} \~{\S} \sgmbe{2}}
    	and \eq{\eqnumthree{12}}
    		{\sgmbe{1} \x{\S} \sgmbe{2} = (\sgmx) [\s_1 \|-> \emptyv,..., \s_j \|-> \emptyv]}
    	
    	By IH on \ref{\eqnumthree{11}} with $\MP_1'$, $\MP_2'$, \ref{eq-lem24-c3-4}, we get a derivation 
    	\[ \seval{p'}{\sgmbe{1} \x{\S} \sgmbe{2}}{\cc }{\sgmpx} \] 
    	
        Replacing the start store with the right-hand side of \ref{\eqnumthree{12}} gives us a derivation $\MP'$ of
   		
   		\[\seval{p'}{(\sgmx) [\s_1 \|-> \emptyv,..., \s_j \|-> \emptyv]}{\cc }{\sgmpx} \] 
   		
   		Since \ref{eq-lem24-c3-as5} with \ref{eq-lem24-c3-7} and \ref{eq-lem24-c3-9}, we have 
   		
   		$$(\sgmx) [\s_1 \|-> \emptyv,..., \s_j \|-> \emptyv](\s_c) = \emptyv$$
   		
   		Therefore, using $\PName{Wc-Emp}$ we can build $\MP$ as follows
   		$$\PT{
   			\UCN{\MP'}{\seval{p'}{(\sgmx) [\s_1 \|-> \emptyv,..., \s_j \|-> \emptyv]}{\cc }{\sgmpx} }
   			\UC{\seval{\casethree}{\sgmx}{\cc}{\sgmpx}}
   		}$$
   		
   		as required. \\
   
   	\item Subcase $\MP_1$ uses  $\PName{Wc-Nomemp}$, $\MP_2$ uses $\PName{Wc-Emp}$. \\
   	
   	$\MP_1$ must look like
   	$$\PT{
   			\UCN{\MP_1'}{\seval{p_0}{\sgm_1}{\c_1'}{\sgm_1''}}
   			\UCN{\MP_1''}{\seval{p'}{\sgm_1[\s_1 \|-> \sgm_1''(\s_1),...,\s_j \|-> \sgm''(\s_j)]}{\c_1}{\sgm_1'}}
   			\BC{\seval{\casethree}{\sgm_1}{\c_1}{\sgm_1'}}
   	}$$
    and we have 
    \eq{\eqnumthree{20}}{\sgm_1(\s_c)= \c_1' = \< () | ...\'>}
   	
   	$\MP_2$ must look like	
   	$$\PT{
   		\UCN{\MP_2'}{\seval{p'}{\sgm_2[\s_1 \|-> \emptyv, ..., \s_j \|-> \emptyv]}{\c_2}{\sgm_2'}}
   		\UC{\seval{\casethree}{\sgm_2}{\c_2}{\sgm_2'}}
   	}$$
   	and we have     	
   	\eq{\eqnumthree{21}}{\sgm_2(s_c) = \emptyv}
   	and 
   	\eq{\eqnumthree{22}}{\forall s \in \FV{p_0}. \sgm_2(s) = \emptyv}
 
 \def\sgmbpp#1{\sgm_{#1}[\s_1 \|-> \sgm_{#1}''(\s_1),...,\s_j \|-> \sgm_{#1}''(\s_j)]} 


    By Lemma \ref{lem-emp-join} on $\sgm_1 \~{\S} \sgm_2$ with $\MP_1'$, \ref{\eqnumthree{22}}, \ref{eq-lem24-c3-as6}, we obtain a derivation $\MP_0$
    of 
    $$\seval{p_0}{\sgmx}{\c_1'}{\sgm_0}$$ for some $\sgm_0$, and 
    $$\forall s \in dv(p_0). \sgm_0(s) = \sgm_1''(s), $$
    thus,  with \ref{eq-lem24-c3-2}, we have
    \eq{\eqnumthree{25}} {(\sgm_0(s_i) = \sgm_1''(s_i))^j_{i=1}}
    


   		Since $\sgm_1 \~{\S} \sgm_2$, it is easy to show that
	   	\eq{\eqnumthree{23}}
	   	{\sgmbpp{1} \~{\S} \sgmbe{2}}
	   	and \eq{\eqnumthree{24}}
	   	{\sgmbpp{1} \x{\S} \sgmbe{2} = (\sgmx) [\s_1 \|-> \sgm_1''(\s_1),..., \s_j \|-> \sgm_1''(\s_j)]}
	   	
	   	By IH on \ref{\eqnumthree{23}} with $\MP_1''$, $\MP_2'$, \ref{eq-lem24-c3-4}, we get a derivation 
	   	\[ \seval{p'}{\sgmbpp{1} \x{\S} \sgmbe{2}}{\cc }{\sgmpx} \] 
	   	
	   	Replacing the start store with the right-hand side of \ref{\eqnumthree{24}} gives us a derivation $\MP'$ of
	   	
	   	\[\seval{p'}{(\sgmx) [\s_1 \|-> \sgm_1''(\s_1),..., \s_j \|-> \sgm_1''(\s_j)]}{\cc }{\sgmpx} \] 
	   	
	   	Since $\ref{\eqnumthree{25}}$, we replcace $\sgm_1''(i)$ with $\sgm_0(i)$ for all $i \in {1,...,j}$, then we obtain  $\MP''$ of
	   	
   		\[\seval{p'}{(\sgmx) [\s_1 \|-> \sgm_0(\s_1),..., \s_j \|-> \sgm_0(\s_j)]}{\cc }{\sgmpx} \] 
   		
   		Using the rule $\PName{Wc-Nonemp}$ we can build $\MP$ as follows
   	
   		$$\PT{
   			\UCN{\MP_0}{\seval{p_0}{\sgmx}{\c_1'}{\sgm_0}}
   			\UCN{\MP''}{\seval{p'}{(\sgmx) [\s_1 \|-> \sgm_0(\s_1),..., \s_j \|-> \sgm_0(\s_j)]}{\cc }{\sgmpx}}
   			\BC{\seval{\casethree}{\sgmx}{\cc}{\sgmpx}}
   		}$$\\
   	
	\item Subcase $\MP_1$ uses  $\PName{Wc-Emp}$ and $\MP_2$ uses $\PName{Wc-Nonemp}$. \\	
	This subcase is analogous to the second one. \\
 		
	\item Subcase both $\MP_1$ and $\MP_2$ use $\PName{Wc-Nonemp}$. \\
 		
   	
    \end{itemize}	
	\end{itemize}
\end{proof}

Let $\sgm_1 \ConEq{\s} \sgm_2$ denote $\forall \s' < \s. \sgm_1(\s') = \sgm_2(\s')$. 
	
\begin{lem}\label{lem-join2}
	If $\sgm_1 \~{\S_1} \sgm'_1$, $\sgm_2 \~{\S_2} \sgm'_2$, $\sgm_1 \ConEq{s} \sgm_2$,
	and $\sgm'_1 \ConEq{\s} \sgm_2'$  
	then $\sgm_1 \x{\S_1} \sgm_1' \ConEq{s} \sgm_2 \x{\S_2} \sgm'_2$. 
\end{lem}

\subsection{SVCODE determinism theroem}

\begin{defi}
	$\a$ is a $prefix$ of $\a'$ if $\a \prefix \a'$: \\
	\Jug{\a \prefix \a'}
	\PT{\Axiom{\emptyv \prefix \a }}
	\PT{
		\AC{\a \prefix \a'}
		\UC{\<a_0 | \a \'> \prefix \<a_0 | \a' \'>}
	}
	
\end{defi}


\begin{lem}
	If
	\begin{enumerate}[(i)]
		\item $(\a_i' \prefix  \a_i)^k_{i=1}$ and $\block{\a_1'}{\a_k'}{\a'}$, 
		\item $(\a_i'' \prefix \a_i)^k_{i=1}$ and
		$\block{\a_1''}{\a_k''}{\a''}$
	\end{enumerate} 
	then \begin{enumerate}[(i)]
		\item $(\a_i' = \a_i'')^k_{i=1}$ 
		\item $\a' = \a''$.
	\end{enumerate}
\end{lem}

\begin{lem} \label{thm-lcall-determ}
	If $\sevalfg{\lcall}{\replc{k}{\a}}{\c}{\a}$,
	and $\sevalfg{\lcall}{\replc{k}{\a}}{\c}{\a'}$,
	then $\a = \a'$.
\end{lem}

\begin{thm}[\textbf{SVCODE determinism}] \label{thm-svcode-determ}
	If $\seval{p}{\sgm}{\c}{\sgm'}$ and $\seval{p}{\sgm}{\c}{\sgm''}$, 
	then $\sgm' = \sgm''$.
\end{thm}


\section{Translation}



\subsection{Translation rules}
\begin{enumerate}[(1)]
	\item Stream tree: $$ \STree \ni \st ::= \s \ | \ (\st_1,\s) $$
	\item Convert a stream tree to a list of  stream ids:
	      \begin{align*}
	      &\bar{}: \STree \-> \S \\
	      &\overline{\s} = [s] \\
	      &\overline{(\st,s)} = \overline{st} {\++} [s]
	      \end{align*}

	
	\item Translation environment: $$\del = [x_1 \|-> \st_1,..., x_i \|-> {\st_i}] $$ 
	
	
\end{enumerate}

\begin{itemize}	

\item \Jug{\Trans{\del}{e}{\s_0}{\s_1}{\sfun{p}{\st}}}

\PT{\AC{}
	\RiLa{(\del(x)= \st)}
	\UC{\Trans{\del}{x}{\s_0}{\s_0}{\sfun{\epsilon}{\st}}}
}
\PT{\AC{\Trans{\del}{e_1}{\s_0}{\s_0'}{\sfun{p_1}{\st_1}}}
	\AC{\Trans{\del[x \|-> {\st_1}]}{e_2}{\s_0'}{\s_1}{\sfun {p_2} {\st}}}
	\BC{\Trans{\del}{\Let{x}{e_1}{e_2}}{\s_0}{\s_1}{\sfun {p_1;p_2} {\st}}}
}

\PT{
	\AC{\Transf{\hcall}{\replc{k}{st}}{\s_0}{\s_1}{\sfun{p}{\st}}}
	\RiLa{((\del(x_i)=\st_i)^k_{i=1})}
	\UC{\Trans{\del}{\hcall \Tupk{x}}{\s_0}{\s_1}{\sfun{p}{\st}}}
}

\PT{
	\AC{\Trans{[x \|-> {\st_1}]}{e}{\s_0+1}{\s_1}{\sfun{p_1}{\st}}}
	\RiLa{\left(
		   \begin{aligned}
		    &\del(y)=(\st_1,\s_2) \\
		    &\Sin = \{\s_0\} \cup \FV{p_1} \\
		    &\Sout = \overline{\st} \cap \dv{p_1}
		   \end{aligned}
		 \right)}
	\UC{\Trans{\del}{\Comp{e}{x}{y}{\cdot}}{\s_0}{\s_1}{\sfun{\sdef{\s_0}{\usum(\s_2)}; \withctrl{\s_0}{p_1}{\Sin}{\Sout}}{(\st,\s_2)}}}
}


\item Auxiliary \Jug{\Transf{\hcall}{\replc{k}{st}}{\s_0}{\s_1}{\sfun{p}{\st}}}

\PT{
	\Axiom{\Transf{\constn{n}}{}{\s_0}{\s_0+1}
		\sfun{\sdef{\s_0}{\consta{n}()}}{\s_0}  }
} \\ [6ex]

\PT{
	\AC{}
	\RiLa{\left( \begin{aligned}
		  \s_{i+1} & = \s_i + 1, \forall i \in \{0,...,3\} \\
		  p= & \sdef{\s_0}{\toflag(\s)} ; \\ 
		     & \sdef{\s_1}{\usum(s_0)} ; \\
		     & \withctrl{\s_1}{\sdef{\s_2}{\consta{1}()}}{[\s_1]}{\overline{\s_2}}; \\
	         & \sdef{\s_3}{\scan_{0}(\s_0,s_2)}
	    \end{aligned}\right)
    }
	\UC{\Transf{\iotan}{\s}{\s_0}{\s_4}{\sfun{p} {(\s_3,\s_0)}}}
}\\[4ex]

\PT{
	\Axiom{\Transf{\plusn}{\s_1,\s_2}{\s_0}{\s_0+1}
	    \sfun{\sdef{\s_0}{\maptwo{+}(\s_1,\s_2)}}{\s_0}}
}

\end{itemize}


\subsection{Value representation}
\begin{enumerate}
	\item SVCODE values: $$\SvVal \ni \v ::= \a \ | \ (\v,\b) $$
	\item SVCODE values concatenation: \\ 
	   \begin{align*}
	   	 &\++: \SvVal \->  \SvVal \-> \SvVal \\
	   	 &\vapp{\<\a_1,...,\a_i\'>}{\<\a_1',...,\a_j'\'>} = \<\a_1,...,\a_i,\a_1',...,\a_j'\'> \\
	   	&\vapp{(\v_1,\b_1)}{(\v_2,\b_2)} = (\vapp{\v_1}{\v_2}, \vapp{\b_1}{\b_2})
	   \end{align*}
	   
	\item SVCODE value construction from a stream tree: \\
	\begin{align*}
		&\sgm : \STree \-> \SvVal \\
		&\sgm(\s) = \a \\
		&\sgm((\st,\s)) = (\sgm(\st), \sgm(\s)) 
	\end{align*}
	
	
	\item Value representation rules
	\begin{itemize}
		
		\item \Jug{\ValRep{v}{\tau}{\v}}
		
		\PT{
			\Axiom{\ValRep{n}{\int}{\singl{n}}}
		}
		\PT{
			\AC{(\ValRep{v_i}{\tau}{\v_i})^k_{i=1}}
			\RiLa{(\v = \v_1 {\++} ... {\++} \v_k)}
			\UC{\ValRep{\Seqk{v}}{\tseq{\tau}}{(\v,\langle \F_1,..., \F_k, \T \rangle)}}
		}
	\end{itemize}
\end{enumerate}




\begin{comment}
\PT{
	\AC{\ValRep {\lrange{v_1}{v_k}} {\tau} {\v}}
	\UC{\ValRep {\Seqk{v}}{\tseq{\tau}}{(\v,\langle \F_1,..., \F_k, \T \rangle)}}
}\\[4ex]

\item \Jug{\ValRep{\lrange{v_1}{v_k}}{\tau}{\v}}
\PT{
	\Axiom{\ValRep{\lrange{n_1}{n_k}}{\int}{\vrange{n_1}{n_k}}}
}
\PT{
	\AC{\ValRep{v_i}{\tau}{\v}}
	\UC{\ValRep{\lrange{v_1}{v_k}}{\tseq{\tau}}{}}
}

\end{comment}



\begin{lem}[\textbf{Value translation backwards determinism}]
	If $\ValRep{v}{\tau}{w}$, $\ValRep{v'}{\tau}{w}$,
	then $v=v'$.
\end{lem}


\subsection{Correctness proof}

\begin{lem}[???] \label{lem-seqs-sids}
	If $\Type{\Gam}{e}{\tseq{\tau}}$,  $\Eval{\rho}{e}{\Seqk{v}}$,
	and $\Trans{\del}{e}{\s_0}{\s_1}{\sfun{p}{(\st,\s)}}$,
	then $\s \notin \sids{\st}.$
\end{lem}

\begin{lem}
	\label{function-correctness}
	If 
	\begin{enumerate}[(i)]
	\item $\Typef{\hcall}{\replc{k}{\tau}}\tau$ (by some derivation $\MT$)
	\item $\EvalF{\hcall}{\replc{k}{v}}{v}$ (by $\ME$)
	\item $\Transf{\hcall}{\replc k {\st}} {\s_0} {\s_1} {\sfun{p}{\st}}$ (by $\MC$)
 	\item $(\ValRep{v_i}{\tau_i}{\sgm(\st_i)})^k_{i=1}$
 	\item $\bigcup^k_{i=1}\sids{\st_i} \.< \s_0$
	\end{enumerate}
 	then 
 	\begin{enumerate}[(i)]
 		\setcounter{enumi}{5}
 		\item $\seval{p}{\sgm}{\vunit}{\sgm'}$ (by $\MP$)
 		\item $\ValRep{v}{\tau}{\sgm'(\st)}$ (by $\MR$)
 		\item $\sgm' \ConEq{s_0} \sgm $
 	    \item $\s_0 \le \s_1$
 		\item $\sids{\st} \.< \s_1$

 	\end{enumerate}
\end{lem}

\begin{proof}
By inducntion on the syntax of $\hcall$.
\begin{itemize}
	\item \label{thm-case-const} Case $\hcall = \constn{n}$ \\ 	
	There is only one possibility for each of $\MT$, $\ME$ and $\MC$:
	$$\MT = \PT{ \Axiom{\Typef{\constn{n}}{}{\int}}}$$
	$$\ME = \PT{\Axiom{\Eval{}{\const{n}}{n}}}$$
	$$\MC = \PT{\Axiom{\Transf{\constn{n}}{}{\s_0}{\s_0+1}
			{\sfun{\sdef{\s_0}{\constaf{n}}}{\s_0}}}}$$

\def\pconst{\sdef{\s_0}{\constaf{n}}}
	So $k=0,\tau = \int, v = n, p = \pconst$, $\s_1 = \s_0+1$, and $\st = \s_0$

	By $\PName{Xducer}$, $\PName{X-Loop}$, $\PName{X-Termi}$ and $\PName{Const}$, we can construct $\MP$ as follows:
	$$\PT{
		\Axiom{\blockf{\consta{n}}{}{\singl{n}}}
		\Axiom{\sevalfg{\consta{n}}{}{\emptyv}{\emptyv}}
		\BC{\sevalfg{\consta{n}}{}{\vunit}{\singl{n}}}
		\LeLa{\MP = }
		\UC{\seval{\pconst}{\sgm}{\vunit}{\sgm[\s_0 \|-> \singl{n}]}}			
	}$$
	So $\sgm' = \sgm[\s_0 \|-> \singl{n}]$.
	
	Then we take $\MR$ = $\PT{\Axiom{\ValRep{n}{\int}{\sgm'(\s_0)}}}$. \\
	Also clearly, $\sgm' \ConEq{\s_0} \sgm$, $\s_0 \le \s_0 +1$, 
	$\sids{\s_0} \.< \s_0 +1$, and we are done.
		
	\item \label{thm-case-plus} Case $\hcall = \plusn$ \\ 	
	We must have 
	$$\MT = \PT{\Axiom{\Typef{\plusn}{\int,\int}{\int}}}$$
	$$\ME = \PT{\Axiom{\Eval{}{\plus{n_1}{n_2}}{n_3}}}$$ where $n_3 = n_2 + n_1$, and 
	$$\MC = \PT{\Axiom{\Transf{\plusn}{s_1,s_2}{\s_0}{s_0+1}
			{\sfun{\sdef{\s_0}{\maptwof{+}{\s_1}{\s_2}}}}{\s_0}}}$$

\def\pplus{\sdef{\s_0}{\maptwof{+}{\s_1}{\s_2}}}	
	So $k=2,\tau_1 = \tau_2 = \tau = \int, v_1= n_1, v_2= n_2, v = n_3,
	 \st_1= \s_1, \st_2 = \s_2, \st = \s_0, \s_1 = \s_0 +1$
	 and $p = \pplus$. \\
	 
	 Assumption (iv) gives us
	 $\infer{\ValRep{n_1}{\int}{\sgm(\s_1)}}{}$ and 
	 $\infer{\ValRep{n_2}{\int}{\sgm(\s_2)}}{}$, which implies
	 $\sgm(\s_1) = \singl{n_1}$ and $\sgm(\s_2) = \singl{n_2}$ respectively. \\
	 
	 For (v) we have $\s_1 < \s_0$ and $\s_2 < \s_0$. \\
	 
	 Then using $\PName{Xducer}$ with $\sgm(\s_1)= \singl{n_1}$ and $ \sgm(\s_2) = \singl{n_2}$, 
	 and using $\PName{X-Loop}$ and $\PName{X-Termi}$, 
	 we can build $\MP$ as follows: 
	 $$\PT{
		\Axiom{\blockf{\maptwo{+}}{\singl{n_1}, \singl{n_2}}{\singl{n_3}}}
		\Axiom{\sevalfg{\maptwo{+}}{\emptyv,\emptyv}{\emptyv}{\emptyv}}
		\BC{\sevalfg{\maptwo{+}}{\singl{n_1},\singl{n_2}}{\vunit}{\singl{n_3}}}
		\UC{\seval{\pplus}{\sgm}{\vunit}{\sgm[\s_0 \|-> \singl{n_3}]}}
	 }$$  
	
	
	Therefore, $\sgm' = \sgm[\s_0 \|-> \singl{n_3}]$.\\
	Now we can take $\MR = \infer{\ValRep{n_3}{\int}{\sgm'(\s_0)}}{}$,
	and it is clear that
	 $\sgm' \ConEq{\s_0} \sgm$, $\s_0 \le \s_0 +1$ 
	 and $\sids{\s_0} \.< \s_0+1$ as required. 
	
%case iota	
	\item \label{thm-case-iota} Case $\hcall = \iotan$ \\ 	
	
\end{itemize}
\end{proof}


\begin{thm}
	\label{mainthm-correctness}
	\textbf{If} 
	\begin{enumerate}[(i)]
		\item $\Type{\Gam}{e}{\tau}$ (by some derivation $\MT$)
		\item $\Eval{\rho}{e}{v}$ (by some $\ME$) 
		\item $\Trans{\del}{e}{\s_0}{\s_1}{\sfun{p}{\st}}$ (by some $\MC$)
		\item \label{mainthm-assum-env} $\forall x \in dom(\Gam). \Type{}{\rho(x)}{\Gam(x) } \wedge \sids{\del(x)} \.< \s_0  \wedge  \ValRep{\rho(x)}{\Gam(x)}{\sgm(\del(x))}$ \\
	\textbf{then} 
		\item $\seval{p}{\sgm}{\singl{()}}{\sgm'}$ (by some derivation $\MP$)
		\item  $\ValRep{v}{\tau}{\sgm'(\st)}$ (by some $\MR$)
		\item $\sgm' \ConEq{s_0} \sgm $
	    \item $\s_0 \le \s_1$
		\item  $\sids{\st} \.< \s_1$
	\end{enumerate} 
\end{thm}

\begin{proof}
	By induction on the syntax of $e$.
	
	\begin{itemize}
		\item Case $e = \Comp{e_1}{x}{y}{\cdot}$. \\
   
\def\kunit{\vrange{()_1}{()_k}} 
\def\stwo{\< \F_1,..., \F_k, \T \'>}
\def\sgmszs{\sgm[\s_0 \|-> \kunit, \st_2 \>-> \sgm''(\st_2)]}
\def\sgmsz{\sgm[\s_0 \|-> \kunit]}

		We must have: 
		\begin{enumerate}[(i)]
		\item 
		\PT{
			\UCN{\MT_1}{\Type{[x \|-> {\tau_1}]}{e_1}{\tau_2}}
			\LeLa{\MT = }
			\RiLa{(\Gam(y)=\tseq{\tau_1})}
			\UC{\Type{\Gam}{\Comp{e_1}{x}{y}{\cdot}}{\tseq{\tau_2}}}
		}
		
		\item
		\PT{
			\UCN{\ME_i}{(\Eval{[x \|-> {v_i}]}{e_1}{v_i'})^k_{i=1}}
			\LeLa{\ME = }
			\RiLa{(\rho(y)=\Seqk{v})}
			\UC{\Eval{\rho}{\Comp{e_1}{x}{y}{\cdot}}{\Seqk{v'}}}
		} 
		
		\item 
		\PT{
			\UCN{\MC_1}{\Trans{[x \|-> {\st_1}]}{e_1}{\s_0+1}{\s_1}{\sfun{p_1}{\st_2}}}
			\LeLa{\MC = }
			\RiLa{(\del(y)=(\st_1,\s_2))}
			\UC{\Trans{\del}{\Comp{e_1}{x}{y}{\cdot}}{\s_0}{\s_1}
				{\sfun{\sdef{\s_0}{\usum(\s_2)}; \withctrl{\s_0}{p_1}{\Sin}{\overline{\st_2}}}{(\st_2,\s_2)}}}
		}
	
	 So $p= (\sdef{\s_0}{\usum(\s_2)}; \withctrl{\s_0}{p_1}{\Sin}{\overline{\st_2}}),
	\tau = \tseq{\tau_2}, v = \Seqk{v'}, \st = (\st_2,\s_2). $ \\

	\item $\Type{}{\rho(y)}{\Gam(y)}$ gives us $\Type{}{\Seqk{v}}{\tseq{\tau_1}}$, 
	which must have the derivation:
	\begin{equation}\label{comp-ass-vi}	
	\PT{
		\AC{(\Type{}{v_i}{\tau_1})^k_{i=1}}
		\UC{\Type{}{\Seqk{v}}{\tseq{\tau_1}}}}
	\end{equation}
	
	$\sids{\del(y)} \.< \s_0$ gives us
	\begin{equation} \label{comp-ass-st1-s2}
	    \sids{\del(y)} = \sids{(\st_1,\s_2)} 
	    = \sids{\st_1} \cup \{s_2\} \.< \s_0
 	\end{equation}
	
	$\ValRep{\rho(y)}{\Gam(y)}{\sgm(\del(y))} =
 	 \ValRep{\Seqk{v}}{\tseq{\tau_1}}{\sgm((\st_1,\s_2))}$ 
 	 must have the derivation: 
 	 \eq{comp-ass-valrep}{
 	 \PT{
		\UCN{\MR_i}{(\ValRep{v_i}{\tau_1}{\v_i})^k_{i=1}}
		\RiLa{(w =  w_1 \ {\++} ... {\++} \ w_k)}
		\UC{\ValRep{\Seqk{v}}{\tseq{\tau_1}}{(w,\stwo)}}
	 }}
    therefore 
    \eq{comp-ass-sgmst1}
    {\sgm(\st_1) = w}

    and \eq{comp-ass-sgms2}
    {\sgm(\s_2) = \< \F_1,..., \F_k, \T \'>.}
    
	\end{enumerate}


%% proof		
First we shall show: 
	\begin{enumerate}[(i)]
	\setcounter{enumi}{4}
	
	\item \label{comp-5}$\seval{\sdef{\s_0}{\usum(\s_2)}; \withctrl{\s_0}{p_1}{\Sin}{\overline{\st_2}}}{\sgm}{\singl{()}}{\sgm'}$
	by some $\MP$
	\item $\ValRep{\Seqk{v'}}{\tseq{\tau_2}}{\sgm'((\st_2,\s_2))}$ by some $\MR$
	\item $\sgm' \ConEq{\s_0} \sgm$ \\

\def\usumdef{\sdef{\s_0}{\usum(\s_2)}} 

	By $\PName{Seq}$, we can build $\MP$ as follows:
	$$ \PT{
		\UCN{\MP_0}{\seval{\sdef{\s_0}{\usum(\s_2)}}{\sgm}{\singl{()}}{\sgm_0}}
		\UCN{\MP_1}{\seval{\withctrl{\s_0}{p_1}{\Sin}{\overline{\st_2}}}{\sgm_0}{\<()\'>}{\sgm'}}
		\BC{\seval{\sdef{\s_0}{\usum(\s_2)}; \withctrl{\s_0}{p_1}{\Sin}{\overline{\st_2}}}{\sgm}{\singl{()}}{\sgm'}}
	} $$
    
    By $\PName{Xducer}$ with $\sgm(\s_2) = \stwo$, we can continue to build $\MP_0$ as follows:
  
    $$\PT{
    	\UCN{\MP_0'}{\sevalfg{\usum}{\stwo}{\vunit}{\a}}
    	\LeLa{\MP_0 = }
    	\UC{\seval{\usumdef}{\sgm}{\vunit}{\sgm[\s_0 \|-> \a]}}
    }$$
    So $\sgm_0 = \sgm[\s_0 \|-> \a]$.\\
	We split $\stwo$ into two parts: $\b_1 = \stwo$ and $\b_2 = \emptyv$. \\
	By $\PName{X-loop}$ and $\PName{X-termi}$ with $\b_1$ and $\b_2$, we continue building $\MP_0'$ as follows:

	 $$\PT{
		\UCN{\MP_0''}{\blockf{\usum}{\b_1}{\a}}
		\Axiom{\sevalfg{\usum}{\b_2}{\emptyv} \emptyv}
		\LeLa{\MP_0' = }
		\BC{\sevalfg{\usum}{\stwo}{\vunit}{\a}}
	}$$
	

	Then using $\PName{UsumF}$ $k$ times and $\PName{UsumT}$ once, we obtain
	$$\MP_0'' = \vcenter{
	    \infer{\blockf{\usum}{\stwo}{\kunit}} 
	      {\infer*{\blockf{\usum}{\<\F_2,...,\F_k,\T\'>}{\< ()_2,...,()_k\'>}} 
	    	{\infer {\blockf{\usum}{\singl{\T}}{\emptyv}}
	    		{}
	    	  }}	  
     } $$ 
 
 	Thus so far we have constructed 
	$\MP_0$ of $ \seval{\sdef{\s_0}{\usum(\s_2)}} {\sgm} {\singl{()}}
	{\sgmsz}$.
	

	
% IH --------	
	Since we have 
	$$\MT_1 = \PT{\AC{\Type{[x \|-> {\tau_1}]}{e_1}{\tau_2}}}$$
	$$(\ME_i = \PT{\AC{\Eval{[x \|-> {v_i}]}{e_1}{v_i'}}})^k_{i=1} $$
	$$\MC_1 = \PT{\AC{\Trans{[x \|-> {\st_1}]}{e_1}{\s_0+1}{\s_1}{\sfun{p_1}{\st_2}}}}$$
	
	Let $\Gam_1 = [x \|-> \tau_1], \rho_i= [x \|-> v_i]$ and $\del_1 = [x \|-> \st_1]$. \\
	From \eqref{comp-ass-vi} and \eqref{comp-ass-st1-s2} it is clear that 
	$$\forall z \in dom(\Gam_1). \Type{}{\rho_i(z)}{\Gam_1(z)} \wedge 
	\sids{\del_1(z)} \.< \s_0 .$$
	
	Let $i$ range from $1$ to $k$: we take $\sgm_i \~{\st_1} \sgm[\s_0 \|-> \<()_1,...,()_k \'>]$ 
	such that $\sgm_i(\st_1)= w_i$. \\
	From $\MR_i$ in \eqref{comp-ass-valrep} we know that  
	$$\forall z \in dom(\Gam_1). \ValRep{\rho_i(z)}{\Gam_1(z)}{\sgm_i(\del_1(z))}.$$
	
	
	Then  by IH ($k$ times) on $\MT_1$ with $\ME_i$, 
	$\MC_1$ we obtain the following result:
	\eq{compIH1}{(\seval{p_1}{\sgm_i}{\<()\'>}{\sgm_i'})^k_{i=1}}
	\eq{compIH2}{(\ValRep{v'_i}{\tau_2}{\sgm_i'(\st_2)})^k_{i=1}}
	\eq{compIH3}{(\sgm_i' \ConEq{\s_0 +1} \sgm_i)^k_{i=1}}
	\eq{compIH4}{\s_0+1 \le \s_1}
	\eq{compIH5}{\sids{\st_2} {\.<} \s_1}
% ----------- 	


	Assume $\sids{\st_2} = \{\s'_1,...,\s'_j\}$.\\
	
	There are two possibilities:
	\begin{itemize}
%subcase k= 0
	\item 
	Subcase $k=0$, that is $\sgmsz(\s_0) = \emptyv$.\\
	By $\PName{Wc-Emp}$ We build
	$$\PT{
		\AC{}
		\LeLa{\MP_1 = }
		\UC{\seval{\withctrl{\s_0}{p_1}{\Sin}{\overline{\st_2}}}{\sgm}{\< () \'>}
			{\sgm[\s_0 \|-> \emptyv, \s_1' \|-> \emptyv, ..., \s_j' \|-> \emptyv]}}
	  }$$ 
    So in this subcase, 
    $$\sgm' = \sgm[\s_0 \|-> \emptyv, \s_1' \|-> \emptyv, ..., \s_j' \|-> \emptyv].$$ 

\def\sgmpempty{\sgm[\s_0 \|-> \emptyv, \s_1' \|-> \emptyv, ..., \s_j' \|-> \emptyv]}

% vi	
	Since $k=0$, then $v = \{ \}$, $\sgm(\s_2) = \oT$ (from \eqref{comp-ass-sgms2}), we have \\
	{\color{red} $\sgm'(\s_2) = \sgm(\s_2) = \oT$ (?? not correct if $\s_2 \in \sids{\st_2}/\sids{\st_1}$)}, \\
	and $\sgm'(\st_2) = (...((\emptyv,\emptyv)_1,\emptyv)_2,...)_{j-1}.$ \\
	
	Therefore $\sgm'((\st_2,\s_2)) = (\sgm'(\st_2), \sgm'(\s_2))$, with which we construct 
	$$\MR = 
	\PT{\Axiom{\ValRep{\{\}}{\tseq{\tau_2}}{((...(\emptyv,\emptyv)_1,...)_{j-1},\oT)}}}$$ 
	as required.\\
    
%vii
    Since $k=0$, from \eqref{comp-ass-sgmst1} we know $\forall s' \in \sids{\st_1}. \sgm(s') = \emptyv$. 
    For any $\s' \in \sids{\st_2}$ and $s' < \s_0$, it must have $\s' \in \sids{\st_1}$ 
    (because $codom(\del_1) = \{\st_1\}$), hence $\sgm(\s') = \emptyv = \sgm'(\s')$. 
    Therefore, $$\sgm' \ConEq{\s_0} \sgm.$$
    

%subcase k > 0	
\def\sgmp-nonempty{\sgm[\s_0 \|-> \kunit, \s_1' \|-> \sgm''(\s'_1),...,
	\s'_j \|-> \sgm''(\s'_j)]}  

	\item \label{subcase-2} 
	Subcase $k > 0$, that is $\sgmsz = \< ()|\a \'>$ for some $\a$. \\
	By $\PName{Wc-Nonemp}$, we take $\MP_1 = $
	$$\PT{
		\UCN{\MP_1'}{\seval{p_1}{\sgmsz}{\kunit}{\sgm''}}
		\UC{\seval{\withctrl {s_0} {p_1} {\Sin}{\overline{\st_2}} } 
				  {\sgmsz} 
				  {\vunit} 
				  {\sgmp-nonempty}}
	}.$$
	
	So in this subcase $$\sgm' = \sgmp-nonempty.$$
	
	Using Lemma \ref{lem-sgm-join} (k-1) times on \eqref{compIH1} gives us
	\eq{p1-sgms-sgms'}{
		\seval{p_1}{(\x{\st_1} \sgm_i)^k_{i=1}}{\kunit}{(\x{\st_2'} \sgm'_i)^k_{i=1}}
	}
	where $\st_2' = \sids{\st_1} \cup \sids{\st_2}$ (???) . 
	
	By Definition \ref{def-sgm-join} we have
	\eq{sgms-join}{
		(\x{\st_1} \sgm_i)^k_{i=1} = \sgmsz.}
	
	Then by Theorem \ref{thm-svcode-determ} on $\MP_1'$ with \eqref{p1-sgms-sgms'}, we get
	\eq{sgms'-join}{
		\sgm'' = (\x{\st_2'} \sgm'_i)^k_{i=1}}
	
	Therefore, $\sgm''(\st_2) = \sgm'_1(\st_2) {\++} ... {\++} \sgm'_k(\st_2)$ by Definition \ref{def-sgm-join}.\\
	Let $\sgm'_i(\st_2) = w'_i$ and  $\sgm''(\st_2) = w'$, then
	$w' = w'_1 {\++} ... {\++} w'_k$. \\
	
	Since $\sgm'(\st_2) = \sgm''(\st_2) = w'$, and $\sgm'(\s_2) = \sgm(\s_2) = \stwo$,
	we now have $\sgm'((\st_2,\s_2)) = (\sgm'(\st_2),\sgm'(\s_2)) = (w',\stwo)$. 
	With \eqref{compIH2}, we can construct
	$$\MR = 
	\PT{
		\AC{(\ValRep{v'_i}{\tau_2}{w'_i})^k_{i=1}}
		\UC{\ValRep{\Seqk{v'}}{\tseq{\tau_2}}{(w',\stwo)}}
	}$$ as required. \\

%vii
	By Lemma \ref{lem-join1} on \eqref{sgms-join} we get $\sgm_i \~{\st_1} \sgmsz$, and similarly $\sgm'_i \~{\st_2'} \sgm''$ from \eqref{sgms'-join}. \\
	
	Since \eqref{compIH3} implies $$(\sgm'_i \ConEq{\s_0} \sgm_i)^k_{i=1}$$
	using Lemma \ref{lem-join2} (k-1) times, we obtain 
	$$\sgm'' \ConEq{\s_0} \sgmsz.$$
	Therefore, $\sgm' \ConEq{\s_0} \sgmsz \ConEq{\s_0} \sgm$.\\

	\end{itemize}

% viii
	\item TS: $\s_0 \le \s_1$ \\
	From \eqref{compIH4} we immediately get $\s_0 \le \s_1 -1 < \s_1$.\\
	
%ix
	\item TS: $\sids{(\st_2,\s_2)} {\.<} \s_1$  \\
	From \eqref{comp-ass-st1-s2} we know $\s_2 < \s_0$, thus $ \s_2 < \s_0 \le \s_1$. 
	And we already have \eqref{compIH5}. Therefore,
	$$\sids{(\st_2,\s_2)} = \sids{\st_2} \cup \{s_2\} \.< \s_1.$$
	
	\end{enumerate}

% case variable 
 \item Case $e = x$.\\
 We must have 
 $$\MT = \PT{
 	\AxiomC{}
 	\RiLa{(\Gam(x) = \tau)}
 	\UC{\Type{\Gam}{x}{\tau}}
 }$$
 $$ \ME = 
 \PT{
 	\AxiomC{}
 	\RiLa{(\rho(x)=v)}
 	\UC{\Eval{\rho}{x}{v}}
 }$$
 $$ \MC = 
 \PT{\AC{}
 	\RiLa{(\del(x)= \st)}
 	\UC{\Trans{\del}{x}{\s_0}{\s_0}{\sfun{\epsilon}{\st}}}
 }
 $$
 So $p= \epsilon$. 
 
 Immediately we have $\MP$ =
 $\PT{\Axiom{\seval{\epsilon}{\sgm}{\vunit}{\sgm}}}$\\
 So $\sgm' = \sgm$, which implies $\sgm'  \ConEq{\s_0} \sgm$.\\
 From the assumption we already have $\ValRep{v}{\tau}{\sgm(\st)}$,
 and $\sids{\st} \.< \s_0$. \\
 Finally it's clear that $\s_0 \le \s_0$, and we are done.
 
 
% case let-binding 
 \item \label{case-let} Case $e = \Let{x}{e_1}{e_2}$. \\[1ex]
 We must have:
 $$\PT{
 	\UCN{\MT_1}{\Type{\Gam}{e_1}{\tau_1}}
 	\UCN{\MT_2}{\Type{\Gam[\Map{x}{\tau_1}]}{e_2}{\tau}}
 	\LeLa{\MT =} 
 	\BC{\Type{\Gam}{\Let{x}{e_1}{e_2}}{\tau}}
 }$$
 
 $$\PT{	
 	\UCN{\ME_1}{\Eval{\rho}{e_1}{v_1}}
 	\UCN{\ME_2}{\Eval{\rho[\Map{x}{v_1}]}{e_2}{v}}
 	\LeLa{\ME =} 
 	\BC{\Eval{\rho}{\Let{x}{e_1}{e_2}}{v}}
 }$$ 
 $$\PT{\UCN{\MC_1}{\Trans{\del}{e_1}{\s_0}{\s_0'}{\sfun{p_1}{\st_1}}}
 	\UCN{\MC_2}{\Trans{\del[x \|-> {\st_1}]}{e_2}{\s_0'}{\s_1}{\sfun {p_2} {\st}}}
 	\LeLa{\MC = }
 	\BC{\Trans{\del}{\Let{x}{e_1}{e_2}}{\s_0}{\s_1}{\sfun {p_1;p_2} {\st}}}
 }$$\\[1ex]
 
 So $p = p_1;p_2$. \\
 
 By IH on $\MT_1$ with $\ME_1,\MC_1$, we get 
 \begin{enumerate}[(a)]
 	\item $\MP_1$ of $\seval{p_1}{\sgm}{\vunit}{\sgm_1}$
 	\item $\MR_1$ of $\ValRep{v_1}{\tau_1}{\sgm_1(\st_1)}$
 	\item $\sgm_1 \ConEq{s_0} \sgm$ 
 	\item $\s_0 \le \s_0'$
 	\item $\sids{\st_1} \.< {s_0'}$
 \end{enumerate}
 
  From (b), we know $\rho[\Map{x}{v_1}](x) : \Gamma[\Map{x}{\tau_1}](x)$ and  $\ValRep{\rho[\Map{x}{v_1}](x)}{\Gamma[\Map{x}{\tau_1}](x)}{\sgm_1(\delta[\Map{x}{\st_1}](x))}$ must hold. 
  From (e), we have $\sids{\delta[\Map{x}{\st_1}](x)} \.< s_0'$. 
 
 Then by IH on  $\MT_2$ with $\ME_2,\MC_2$, we get
 \begin{enumerate}	[(a)]
 	\setcounter{enumi}{5}
 	\item $\MP_2$ of $\seval{p_2}{\sgm_1}{\vunit}{\sgm_2}$ 
 	\item $\MR_2$ of $ \ValRep{\sgm_2}{\tau}{\sgm_2(\st)}$
    \item $\sgm_2 \ConEq{\s_0'} \sgm_1$
    \item $\s_0' \le \s_1$
    \item $\sids{\st} \.< {s_1}$
\end{enumerate}

 So we can construct:  
 $$\PT{
 	\UCN{\MP_1}{\seval{p_1}{\sgm}{\vunit}{\sgm_1}}
 	\UCN{\MP_2}{\seval{p_2}{\sgm_1}{\vunit}{\sgm_2}}
 	\LeLa{\MP = }	
 	\BC{\seval{p_1;p_2}{\sgm}{\vunit}{\sgm_2}}
 }$$

 From (c), (d) and (h), it is clear that $\sgm_2 \ConEq{s_0} \sgm_1 \ConEq{s_0} \sgm$.
 From (d) and (i), $\s_0 \le \s_1$.
 
 Take $\sgm' = \sgm_2$ (thus $\MR$ = $\MR_2$)  and we are done. 
 
 
 \item Case $e = \hcall\Tupk{x}$ \\
 We must have  
 $$\PT{
 	\UCN{\MT_1}{\Typef {\hcall} {\replc{k}{\tau}} {\tau}}
 	\LeLa{\MT = }
 	\RiLa{((\Gam(x_i)= \tau_i)^k_{i=1})}
 	\UC{\Type{\Gam}{\hcall{\Tupk{x}}}{\tau}}
 }$$
 $$\PT{
 	\UCN{\ME_1}{\Eval{}{\EvalF{\Tupk{v}}}{v}}
 	\LeLa{\ME = }
 	\RiLa{((\rho(x_i)=v_i)^k_{i=1})}
 	\UC{\Eval{\rho}{\hcall{\Tupk{x}}}{v}}
 }$$
 $$\PT{
 	\UCN{\MC_1}{\Transf{\hcall}{\replc{k}{st}}{\s_0}{\s_1}{\sfun{p}{\st}}}
    \LeLa{\MC =}
 	\RiLa{((\del(x_i)=\st_i)^k_{i=1})}
 	\UC{\Trans{\del}{\hcall \Tupk{x}}{\s_0}{\s_1}{\sfun{p}{\st}}}
 }$$
 
 From our assumption (\ref{mainthm-assum-env}), for all $i \in \{1,...,k\}$:
 \begin{enumerate}[(a)]
 	\item $\Type{}{\rho(x_i)}{\Gam(x_i)}$, that is, $\Type{}{v_i}{\tau_i}$
 	\item $\sids{\del(x_i)} \.< \s_0$, that is, $\sids{\st_i} \.< \s_0$
 	\item $\ValRep{\rho(x_i)}{\Gam(x_i)}{\sgm(\st_i)}$, that is,
 	$\ValRep{v_i}{\tau_i}{\sgm(\st_i)}$
 \end{enumerate}
 
 So using Lemma \ref{function-correctness} on $\MT_1,\ME_1, \MC_1, (a),(b)$ and (c) gives us exactly what we shall show.
 	
	\end{itemize}	
\end{proof}


